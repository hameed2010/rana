import json
import logging
import os
import time
import datetime
import calendar
import subprocess
import sys

from keep_alive import keep_alive
keep_alive()
from typing import Dict, List, Set, Tuple, Any

from telegram.ext import (
    Updater, CommandHandler, CallbackQueryHandler, 
    ConversationHandler, MessageHandler, Filters, CallbackContext
)
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup

# Configure logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Get token from environment variables
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', '8052506477:AAE6YccFnn6-5PyU314H1gi6lmXiKeJlN7c')

# Admin chat ID - replace with the actual admin's chat ID
ADMIN_CHAT_ID = int(os.getenv('ADMIN_CHAT_ID', '821681748'))

# Conversation states
ASKING_QUESTIONS, FINISHED, START_CONFIRMATION, ADMIN_PANEL, EDIT_DESCRIPTION, VIEW_HISTORY, VIEW_MAJOR_INFO = range(7)

# Data file
DATA_FILE = "bot_data.json"

# ุงูุชุฎุตุตุงุช ุงูุฃุณุงุณูุฉ ูุน ููุงุทูุง ุงูุงูุชุฑุงุถูุฉ
majors = {
    # ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ
    "ุชูููููุฌูุง ูุนูููุงุช": 0, "ูุธู ูุนูููุงุช": 0, "ุนููู ุงูุญุงุณูุจ": 0, "ุฃูู ุณูุจุฑุงูู": 0, "ุฌุฑุงููุณ": 0,
    
    # ุชุฎุตุตุงุช ุงูููุฏุณุฉ
    "ููุฏุณุฉ ูุฏููุฉ": 0, "ููุฏุณุฉ ููุฑุจุงุฆูุฉ": 0, "ููุฏุณุฉ ูููุงููููุฉ": 0, "ููุฏุณุฉ ูุนูุงุฑูุฉ": 0, "ูููุงุชุฑูููุณ": 0, "ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 0,
    
    # ุชุฎุตุตุงุช ุงูุตุญุฉ
    "ุทุจ ูุฌุฑุงุญุฉ": 0, "ูุฎุชุจุฑุงุช": 0, "ุชูุฑูุถ": 0, "ุชุฎุฏูุฑ": 0, "ุชุบุฐูุฉ ุนูุงุฌูุฉ": 0, "ุงูุงุดุนุฉ": 0, "ุนูุงุฌ ุทุจูุนู": 0,
    "ุทุจ ุงุณูุงู": 0, "ููู ุงุณูุงู": 0, "ุตูุฏูุฉ": 0,
    
    # ุชุฎุตุตุงุช ุงูุฃุนูุงู
    "ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 0,
    
    # ุชุฎุตุตุงุช ุงูุฅูุณุงููุงุช ูุงูุงุฌุชูุงุน
    "ุนูู ุงูููุณ": 0, "ุชุฑุฌูุฉ": 0,
    
    # ุชุฎุตุตุงุช ุงูุชุฑุจูุฉ
    "ุชุฑุจูุฉ ูุฑุขู": 0, "ุชุฑุจูุฉ ุงุณูุงููุฉ": 0, "ุชุฑุจูุฉ ุฑูุงุถูุงุช": 0, "ุชุฑุจูุฉ ุนุฑุจู": 0, "ุชุฑุจูุฉ ุนููู": 0,
    "ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช": 0, "ุชุฑุจูุฉ ููุฒูุงุก": 0, "ุชุฑุจูุฉ ููููุงุก": 0, "ุชุฑุจูุฉ ุงุญูุงุก": 0, "ุชุฑุจูุฉ ุงูุฌููุฒู": 0
}

# ูุงุฆูุฉ ุงูุฃุณุฆูุฉ ูุน ุงูุฎูุงุฑุงุช ูุงูููุงุท ููู ุชุฎุตุต (30 ุณุคุงู)
questions = [
    # ุฃุณุฆูุฉ ุนู ุงูุชุฎุตุตุงุช ุงูููุฏุณูุฉ (7 ุฃุณุฆูุฉ)
    ("ุฃู ูุฑุน ูู ุงูููุฏุณุฉ ูุซูุฑ ุงูุชูุงูู ุฃูุซุฑุ",
     ["ููุฏุณุฉ ุงูููุจููุชุฑ ูุงูุดุจูุงุช", "ุงูููุฏุณุฉ ุงูุฅูุดุงุฆูุฉ ูุงููุจุงูู", "ููุฏุณุฉ ุงูุทุงูุฉ ูุงูููุฑุจุงุก", "ููุฏุณุฉ ุงูุขูุงุช ูุงููุนุฏุงุช"],
     [{"ุชูููููุฌูุง ูุนูููุงุช": 3, "ูุธู ูุนูููุงุช": 3, "ุฃูู ุณูุจุฑุงูู": 2}, {"ููุฏุณุฉ ูุฏููุฉ": 3, "ููุฏุณุฉ ูุนูุงุฑูุฉ": 3}, {"ููุฏุณุฉ ููุฑุจุงุฆูุฉ": 3, "ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 2}, {"ููุฏุณุฉ ูููุงููููุฉ": 3, "ูููุงุชุฑูููุณ": 3}]),
    
    ("ุนูุฏ ุงูุชูููุฑ ูู ูุดุฑูุน ููุฏุณูุ ูุง ุงูุฐู ูุฌุฐุจู ุฃูุซุฑุ",
     ["ุชุตููู ุจููุฉ ุชุญุชูุฉ ุฃู ูุจุงูู", "ุชุทููุฑ ุฃูุธูุฉ ูุจุฑุงูุฌ ุญุงุณูุจูุฉ", "ุชุตููู ุขูุงุช ูุฃุฌูุฒุฉ", "ุญู ูุดููุงุช ุจูุฆูุฉ ุฃู ุทุจูุฉ"],
     [{"ููุฏุณุฉ ูุฏููุฉ": 3, "ููุฏุณุฉ ูุนูุงุฑูุฉ": 3}, {"ุชูููููุฌูุง ูุนูููุงุช": 3, "ูุธู ูุนูููุงุช": 3, "ุนููู ุงูุญุงุณูุจ": 2}, {"ููุฏุณุฉ ูููุงููููุฉ": 3, "ูููุงุชุฑูููุณ": 3}, {"ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 3}]),
    
    ("ูุง ูู ุงููุดุงุท ุงูุฐู ุชุณุชูุชุน ุจู ุฃูุซุฑุ",
     ["ุจูุงุก ุงูููุงุฐุฌ ูุงูุฃุดูุงู ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ", "ุชุญููู ุงูุจูุงูุงุช ูุญู ุงููุณุงุฆู ุงูุฑูุงุถูุฉ", "ุชูููู ุงูุฃุฌูุฒุฉ ูุฅุนุงุฏุฉ ุชุฑููุจูุง", "ุงูุชุตููู ูุงูุฑุณู ุงูููุฏุณู"],
     [{"ููุฏุณุฉ ูุฏููุฉ": 3, "ููุฏุณุฉ ูุนูุงุฑูุฉ": 2}, {"ูุธู ูุนูููุงุช": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ููุฏุณุฉ ูููุงููููุฉ": 3, "ูููุงุชุฑูููุณ": 3}, {"ููุฏุณุฉ ูุนูุงุฑูุฉ": 3, "ุฌุฑุงููุณ": 2}]),
    
    ("ููู ุชุชุนุงูู ูุน ูุดููุฉ ุชูููุฉ ูู ุฌูุงุฒูุ",
     ["ุฃูุชุญ ุงูุฌูุงุฒ ูุฃุนุงูุฌ ุงููุดููุฉ ุจููุณู", "ุฃุจุญุซ ุนู ุงูุญู ุนุจุฑ ุงูุฅูุชุฑูุช", "ุฃุณุชุนูู ุจุฎุจูุฑ", "ุฃุดุชุฑู ุฌูุงุฒุงู ุฌุฏูุฏุงู"],
     [{"ููุฏุณุฉ ููุฑุจุงุฆูุฉ": 3, "ูููุงุชุฑูููุณ": 3}, {"ุชูููููุฌูุง ูุนูููุงุช": 3, "ุฃูู ุณูุจุฑุงูู": 3, "ูุธู ูุนูููุงุช": 2}, {"ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}]),
    
    ("ูุง ูู ุงูููุงู ุงูููุถู ููุนูู ุจุงููุณุจุฉ ููุ",
     ["ูู ูููุน ุฅูุดุงุฆู ุฃู ููุฏุงูู", "ูู ููุชุจ ููุฏุณู ุฃู ุงุณุชุดุงุฑู", "ูู ูุฎุชุจุฑ ุฃู ูุนูู", "ูู ุดุฑูุฉ ุชูููุฉ ุฃู ุจุฑูุฌุฉ"],
     [{"ููุฏุณุฉ ูุฏููุฉ": 3}, {"ููุฏุณุฉ ูุนูุงุฑูุฉ": 3}, {"ููุฏุณุฉ ูููุงููููุฉ": 3, "ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 3}, {"ุชูููููุฌูุง ูุนูููุงุช": 3, "ูุธู ูุนูููุงุช": 3, "ุนููู ุงูุญุงุณูุจ": 3}]),
    

    
    ("ูุง ูู ุงููุดุฑูุน ุงูุฐู ุชุญูู ุจุฅูุฌุงุฒูุ",
     ["ุชุตููู ูุจูุงุก ูุจูู ุฃู ุฌุณุฑ ูุชููุฒ", "ุชุทููุฑ ูุธุงู ุญุงุณูุจู ุฃู ุชุทุจูู ุฐูู", "ุงุฎุชุฑุงุน ุฌูุงุฒ ุฃู ุขูุฉ ูุจุชูุฑุฉ", "ุงููุณุงููุฉ ูู ุชุทููุฑ ุชูููุงุช ุทุจูุฉ"],
     [{"ููุฏุณุฉ ูุฏููุฉ": 3, "ููุฏุณุฉ ูุนูุงุฑูุฉ": 3}, {"ุชูููููุฌูุง ูุนูููุงุช": 3, "ูุธู ูุนูููุงุช": 3, "ุฃูู ุณูุจุฑุงูู": 3, "ุนููู ุงูุญุงุณูุจ": 3}, {"ููุฏุณุฉ ูููุงููููุฉ": 3, "ูููุงุชุฑูููุณ": 3}, {"ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ": 3}]),

    # ุฃุณุฆูุฉ ุนู ุชุฎุตุตุงุช ุงูุนููู ุงูุตุญูุฉ (7 ุฃุณุฆูุฉ)
    ("ุฃู ูุฌุงู ูู ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ูุซูุฑ ุงูุชูุงูู ุฃูุซุฑุ",
     ["ุชุดุฎูุต ูุนูุงุฌ ุงููุฑุถู ูุจุงุดุฑุฉ", "ุฅุฌุฑุงุก ุงูุชุญุงููู ูุงููุญูุตุงุช ุงููุฎุจุฑูุฉ", "ุชูุฏูู ุงูุฑุนุงูุฉ ุงูุชูุฑูุถูุฉ", "ุงููุณุงุนุฏุฉ ูู ุงูุนูููุงุช ุงูุฌุฑุงุญูุฉ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3, "ุทุจ ุงุณูุงู": 3}, {"ูุฎุชุจุฑุงุช": 3, "ุงูุงุดุนุฉ": 2}, {"ุชูุฑูุถ": 3, "ุชุบุฐูุฉ ุนูุงุฌูุฉ": 2}, {"ุชุฎุฏูุฑ": 3, "ุนูุงุฌ ุทุจูุนู": 2}]),
    
    ("ูุง ุงููุดุงุท ุงูุฐู ุชุณุชูุชุน ุจู ุฃูุซุฑุ",
     ["ุงูุชูุงุนู ูุงูุชูุงุตู ูุน ุงููุฑุถู", "ุงูุชุนุงูู ูุน ุงูุฃุฌูุฒุฉ ูุงูุชูููุงุช ุงูุทุจูุฉ", "ุชุญููู ุงูุนููุงุช ูุงูุจูุงูุงุช", "ุชุญุถูุฑ ูุชุฑููุจ ุงูุฃุฏููุฉ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3, "ุชูุฑูุถ": 3}, {"ุงูุงุดุนุฉ": 3, "ุชุฎุฏูุฑ": 3}, {"ูุฎุชุจุฑุงุช": 3}, {"ุตูุฏูุฉ": 3, "ููู ุงุณูุงู": 2}]),
    
    ("ูุง ูู ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ ุงูุชู ุชูุถููุง ุฃูุซุฑุ",
     ["ุงูุชุดุฑูุญ ูุนูู ูุธุงุฆู ุงูุฃุนุถุงุก", "ุงูููููุงุก ุงูุญูููุฉ", "ุนูู ุงูุฃุญูุงุก ุงูุฏูููุฉ", "ุงูููุฒูุงุก ุงูุทุจูุฉ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3, "ุทุจ ุงุณูุงู": 3}, {"ุตูุฏูุฉ": 3, "ุชุบุฐูุฉ ุนูุงุฌูุฉ": 3}, {"ูุฎุชุจุฑุงุช": 3}, {"ุงูุงุดุนุฉ": 3, "ุชุฎุฏูุฑ": 2}]),
    
    ("ููู ุชุชุนุงูู ูุน ุงูููุงูู ุงูุทุงุฑุฆุฉ ุฃู ุงูุถุบุท ุงูููุณูุ",
     ["ุฃุจูู ูุงุฏุฆุงู ูุฃุชุฎุฐ ูุฑุงุฑุงุช ุณุฑูุนุฉ", "ุฃุชุจุน ุงูุจุฑูุชููููุงุช ูุงูุฅุฌุฑุงุกุงุช ุงููุนุชูุฏุฉ ุจุฏูุฉ", "ุฃุทูุจ ุงููุณุงุนุฏุฉ ูุงูุชูุฌูู ุนูุฏ ุงูุญุงุฌุฉ", "ุฃุดุนุฑ ุจุงูุชูุชุฑ ููุตุนุจ ุนูู ุงูุชุฑููุฒ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3, "ุชุฎุฏูุฑ": 3}, {"ุชูุฑูุถ": 3, "ูุฎุชุจุฑุงุช": 2}, {"ุตูุฏูุฉ": 2, "ููู ุงุณูุงู": 2}, {}]),
    
    ("ูุง ุงูุฐู ูุฌุฐุจู ุฃูุซุฑ ูู ุงููุฌุงู ุงูุตุญูุ",
     ["ุฅููุงุฐ ุญูุงุฉ ุงููุงุณ ูุนูุงุฌูู", "ุงูุชุดุงู ุทุฑู ุชุดุฎูุตูุฉ ุฌุฏูุฏุฉ", "ุชูุฏูู ุงูุฑุนุงูุฉ ูุงูุฏุนู ูููุฑุถู", "ุชุทููุฑ ูุชุฑููุจ ุงูุฃุฏููุฉ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3, "ุทุจ ุงุณูุงู": 3}, {"ูุฎุชุจุฑุงุช": 3, "ุงูุงุดุนุฉ": 3}, {"ุชูุฑูุถ": 3, "ุนูุงุฌ ุทุจูุนู": 3}, {"ุตูุฏูุฉ": 3}]),
    

    
    ("ูุง ูู ุงูุชุญุฏู ุงูุตุญู ุงูุฐู ุชูุชู ุจู ุฃูุซุฑุ",
     ["ููุงูุญุฉ ุงูุฃูุฑุงุถ ุงููุฒููุฉ", "ุชุทููุฑ ุทุฑู ุงูุชุดุฎูุต ุงููุจูุฑ", "ุชุญุณูู ุฌูุฏุฉ ุญูุงุฉ ุงููุฑุถู", "ุชุทููุฑ ุฃุฏููุฉ ูุนูุงุฌุงุช ุฌุฏูุฏุฉ"],
     [{"ุทุจ ูุฌุฑุงุญุฉ": 3}, {"ุงูุงุดุนุฉ": 3, "ูุฎุชุจุฑุงุช": 3}, {"ุชูุฑูุถ": 3, "ุนูุงุฌ ุทุจูุนู": 3, "ุชุบุฐูุฉ ุนูุงุฌูุฉ": 3}, {"ุตูุฏูุฉ": 3}]),

    # ุฃุณุฆูุฉ ุนู ุชุฎุตุตุงุช ุงูููุจููุชุฑ ูุงูุชูููุฉ (7 ุฃุณุฆูุฉ)
    ("ุฃู ูุฌุงู ูู ุชูููุฉ ุงููุนูููุงุช ุชูุถู ุงูุนูู ุจูุ",
     ["ุชุทููุฑ ุงูุจุฑูุฌูุงุช ูุงูุชุทุจููุงุช", "ุฅุฏุงุฑุฉ ุงูุดุจูุงุช ูููุงุนุฏ ุงูุจูุงูุงุช", "ุฃูู ุงููุนูููุงุช ูุญูุงูุฉ ุงูุจูุงูุงุช", "ุชุตููู ุงูุฌุฑุงููู ูุงููุงุฌูุงุช"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ูุธู ูุนูููุงุช": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),
    
    ("ูุง ูู ุงูููุงุฑุฉ ุงูุชู ุชุณุชูุชุน ุจุชุทููุฑูุง ุฃูุซุฑุ",
     ["ูุชุงุจุฉ ุงูุฃููุงุฏ ุงูุจุฑูุฌูุฉ", "ุชุญููู ุงูุจูุงูุงุช ูุงููุนูููุงุช", "ุงุฎุชุจุงุฑ ูุงูุชุดุงู ุงูุซุบุฑุงุช ุงูุฃูููุฉ", "ุงูุชุตููู ุงูุฑููู ูุงูุฅุจุฏุงุนู"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ูุธู ูุนูููุงุช": 3}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),
    
    ("ูุง ูู ุงููุดุฑูุน ุงูุชููู ุงูุฐู ุชุญูู ุจุฅูุฌุงุฒูุ",
     ["ุชุทููุฑ ุจุฑูุฌูุฉ ุฃู ุชุทุจูู ูุจุชูุฑ", "ุชุตููู ูุธุงู ูุนูููุงุช ูุชูุงูู", "ุฅูุดุงุก ูุธุงู ุญูุงูุฉ ูุชุทูุฑ", "ุชุตููู ูููุน ุฃู ูุงุฌูุฉ ูุณุชุฎุฏู ูููุฒุฉ"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 3}, {"ูุธู ูุนูููุงุช": 3}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),
    
    ("ูุง ูู ุฏูุฑู ุงูููุถู ูู ูุฑูู ุชูููุ",
     ["ูุทูุฑ ููุจุฑูุฌ", "ูุญูู ูุธู ููุฏูุฑ ูุดุฑูุน", "ุฎุจูุฑ ุฃูู ูุนูููุงุช", "ูุตูู ููุจุฏุน ุจุตุฑู"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ูุธู ูุนูููุงุช": 3}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),
    

    
    ("ูุง ูู ูุฌุงู ุงูุชูููุฉ ุงูุฐู ุชุฑู ุฃูู ุฃูุซุฑ ุฃูููุฉ ูููุณุชูุจูุ",
     ["ุชุทููุฑ ุงูุจุฑูุฌูุงุช ูุงูุฐูุงุก ุงูุงุตุทูุงุนู", "ุฃูุธูุฉ ุงููุนูููุงุช ูุงูุจูุงูุงุช ุงูุถุฎูุฉ", "ุงูุฃูู ุงูุณูุจุฑุงูู", "ุงูุชุตููู ุงูุฑููู ูุงููุงูุน ุงูุงูุชุฑุงุถู"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ูุธู ูุนูููุงุช": 3}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),
    
    ("ููู ุชุฑู ุชุฃุซูุฑ ุงูุชูููููุฌูุง ุนูู ุงููุฌุชูุนุ",
     ["ุฃุฏุงุฉ ูุชุทููุฑ ุงูุจุฑูุฌูุงุช ูุงูููุชุฌุงุช", "ูุณููุฉ ูุชุญุณูู ุฅุฏุงุฑุฉ ุงููุนูููุงุช", "ุชุญุฏู ุฃููู ูุญุชุงุฌ ููุญูุงูุฉ", "ูุณููุฉ ููุฅุจุฏุงุน ูุงูุชุนุจูุฑ ุงูููู"],
     [{"ุนููู ุงูุญุงุณูุจ": 3, "ุชูููููุฌูุง ูุนูููุงุช": 2}, {"ูุธู ูุนูููุงุช": 3}, {"ุฃูู ุณูุจุฑุงูู": 3}, {"ุฌุฑุงููุณ": 3}]),

    # ุฃุณุฆูุฉ ุนู ุงูุชุฎุตุตุงุช ุงูุงูุชุตุงุฏูุฉ ูุงูุชุฌุงุฑูุฉ (4 ุฃุณุฆูุฉ)
    ("ูุง ุงููุฌุงู ุงูุฐู ูุซูุฑ ุงูุชูุงูู ูู ุนุงูู ุงูุฃุนูุงูุ",
     ["ุงูุชุฌุงุฑุฉ ูุงูุงูุชุตุงุฏ", "ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ูุงููุดุงุฑูุน", "ุงูุชุณููู ูุงููุจูุนุงุช", "ุงููุญุงุณุจุฉ ูุงูุชูููู"],
     [{"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 3}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}]),
    
    ("ููู ุชุฑู ููุณู ูู ุนุงูู ุงููุงู ูุงูุฃุนูุงูุ",
     ["ูุญูู ุงูุชุตุงุฏู ููุณุชุดุงุฑ", "ูุฏูุฑ ุฃุนูุงู ูุงุฌุญ", "ูุณูู ููุฑูุฌ ููููุชุฌุงุช", "ุฎุจูุฑ ูุงูู ููุญุงุณุจ"],
     [{"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 3}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}]),
    
    ("ูุง ูู ูุฏูู ูู ุฏุฑุงุณุฉ ุงูุชุฌุงุฑุฉ ูุงูุงูุชุตุงุฏุ",
     ["ููู ุงููุธู ุงูุงูุชุตุงุฏูุฉ ูุงูุฃุณูุงู ุงูุนุงูููุฉ", "ุฅุฏุงุฑุฉ ุดุฑูุฉ ุฃู ูุดุฑูุน ุฎุงุต", "ุชุทููุฑ ุงุณุชุฑุงุชูุฌูุงุช ุชุณููููุฉ", "ุฅุฏุงุฑุฉ ุงูุดุคูู ุงููุงููุฉ ูุงููุญุงุณุจูุฉ"],
     [{"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 3}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}]),
    
    ("ูุง ุฑุฃูู ูู ุงูุงุณุชุซูุงุฑ ูุงูุฃุณูุงู ุงููุงููุฉุ",
     ["ููุถูุน ููู ูููู ุงูุงูุชุตุงุฏ ุงูุนุงููู", "ูุณููุฉ ูููู ูุชุทููุฑ ุงูุฃุนูุงู", "ูุฑุตุฉ ูุชุญููู ุฃุฑุจุงุญ ูุนูุงุฆุฏ", "ูุฌุงู ูุญุชุงุฌ ููุฏุฑุงุณุฉ ูุงูุชุฎุตุต"],
     [{"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 3}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}, {"ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": 2}]),

    # ุฃุณุฆูุฉ ุนู ุชุฎุตุตุงุช ุงูุนููู ุงูุฅูุณุงููุฉ (4 ุฃุณุฆูุฉ)
    ("ูุง ุงููุฌุงู ุงูุฅูุณุงูู ุงูุฐู ูุฌุฐุจู ุฃูุซุฑุ",
     ["ุนูู ุงูููุณ ูููู ุงูุณููู ุงูุจุดุฑู", "ุงูุชุฑุฌูุฉ ูุงููุบุงุช", "ุนูู ุงูุงุฌุชูุงุน ูุงูุซูุงูุงุช", "ุงูููุณูุฉ ูุงูููุทู"],
     [{"ุนูู ุงูููุณ": 3}, {"ุชุฑุฌูุฉ": 3}, {"ุนูู ุงูููุณ": 2, "ุชุฑุฌูุฉ": 2}, {"ุชุฑุฌูุฉ": 2, "ุนูู ุงูููุณ": 2}]),
    
    ("ูุง ููุน ุงููุชุจ ุงูุชู ุชููู ููุฑุงุกุชูุงุ",
     ["ูุชุจ ุนูู ุงูููุณ ูุงูุชูููุฉ ุงูุจุดุฑูุฉ", "ูุชุจ ุงููุบุงุช ูุงูุฃุฏุจ ุงููุชุฑุฌู", "ูุชุจ ุงุฌุชูุงุนูุฉ ูุซูุงููุฉ", "ูุชุจ ููุณููุฉ ูููุฑูุฉ"],
     [{"ุนูู ุงูููุณ": 3}, {"ุชุฑุฌูุฉ": 3}, {"ุชุฑุฌูุฉ": 2, "ุนูู ุงูููุณ": 2}, {"ุนูู ุงูููุณ": 2}]),
    
    ("ููู ุชูุถู ูุณุงุนุฏุฉ ุงูุขุฎุฑููุ",
     ["ููู ูุดุงูููู ุงูููุณูุฉ ูุชูุฏูู ุงูุงุณุชุดุงุฑุฉ", "ูุณุงุนุฏุชูู ูู ุงูุชูุงุตู ูููู ูุบุงุช ุฃุฎุฑู", "ุชุญููู ุงูุธูุงูุฑ ุงูุงุฌุชูุงุนูุฉ ูุชุฃุซูุฑุงุชูุง", "ููุงูุดุฉ ุงููุถุงูุง ุงูููุฑูุฉ ูุงูููุณููุฉ"],
     [{"ุนูู ุงูููุณ": 3}, {"ุชุฑุฌูุฉ": 3}, {"ุนูู ุงูููุณ": 2}, {"ุชุฑุฌูุฉ": 2}]),
    
    ("ูุง ุงูููุงุฑุฉ ุงูุชู ุชูุชู ุจุชุทููุฑูุง ุฃูุซุฑุ",
     ["ุงูุชุญููู ุงูููุณู ูุงูุฅุฑุดุงุฏ", "ุฅุชูุงู ุงููุบุงุช ูุงูุชุฑุฌูุฉ", "ุฏุฑุงุณุฉ ุงููุฌุชูุนุงุช ูููููุง", "ุงูุชูููุฑ ุงูููุฏู ูุงูููุทูู"],
     [{"ุนูู ุงูููุณ": 3}, {"ุชุฑุฌูุฉ": 3}, {"ุนูู ุงูููุณ": 2}, {"ุชุฑุฌูุฉ": 2}]),

    # ุฃุณุฆูุฉ ุนู ุชุฎุตุตุงุช ุงูุชุฑุจูุฉ/ุงูุชุนููู (4 ุฃุณุฆูุฉ)
    ("ุฃู ูุฌุงู ูู ุงูุชุฑุจูุฉ ูุงูุชุนููู ุชูุถููุ",
     ["ุชุฏุฑูุณ ุงูุนููู ุงูุฏูููุฉ (ุงููุฑุขู ูุงูุชุฑุจูุฉ ุงูุฅุณูุงููุฉ)", "ุชุฏุฑูุณ ุงูุฑูุงุถูุงุช ูุงูุนููู", "ุชุฏุฑูุณ ุงููุบุงุช (ุนุฑุจู/ุงูุฌููุฒู)", "ุชุฏุฑูุณ ุงูููุงุฏ ุงูุงุฌุชูุงุนูุฉ"],
     [{"ุชุฑุจูุฉ ูุฑุขู": 3, "ุชุฑุจูุฉ ุงุณูุงููุฉ": 3}, {"ุชุฑุจูุฉ ุฑูุงุถูุงุช": 3, "ุชุฑุจูุฉ ููุฒูุงุก": 3, "ุชุฑุจูุฉ ููููุงุก": 3, "ุชุฑุจูุฉ ุงุญูุงุก": 3, "ุชุฑุจูุฉ ุนููู": 3}, {"ุชุฑุจูุฉ ุนุฑุจู": 3, "ุชุฑุจูุฉ ุงูุฌููุฒู": 3}, {"ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช": 3}]),
    

    
    ("ูุง ูู ุฃุณููุจ ุงูุชุฏุฑูุณ ุงูููุถู ูุฏููุ",
     ["ุงูุชุฏุฑูุณ ุงูุชูููุฏู ูุงูุดุฑุญ ุงููุจุงุดุฑ", "ุงุณุชุฎุฏุงู ุงูุชุฌุงุฑุจ ูุงูุฃูุดุทุฉ ุงูุนูููุฉ", "ุงุนุชูุงุฏ ุงูุชูููููุฌูุง ูุงููุณุงุฆู ุงูุชุนููููุฉ", "ุงูุชุนูู ุงูุชุนุงููู ูุงูููุงุด"],
     [{"ุชุฑุจูุฉ ูุฑุขู": 3, "ุชุฑุจูุฉ ุงุณูุงููุฉ": 2}, {"ุชุฑุจูุฉ ููุฒูุงุก": 3, "ุชุฑุจูุฉ ููููุงุก": 3, "ุชุฑุจูุฉ ุงุญูุงุก": 3, "ุชุฑุจูุฉ ุนููู": 3}, {"ุชุฑุจูุฉ ุงูุฌููุฒู": 3, "ุชุฑุจูุฉ ุฑูุงุถูุงุช": 2}, {"ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช": 3, "ุชุฑุจูุฉ ุนุฑุจู": 2}]),
    
    ("ูุง ุงููุงุฏุฉ ุงูุชู ููุช ุชุชููู ูููุง ูู ุงููุฏุฑุณุฉุ",
     ["ุงูุชุฑุจูุฉ ุงูุฅุณูุงููุฉ ูุงููุฑุขู", "ุงูุฑูุงุถูุงุช ูุงูุนููู", "ุงููุบุงุช (ุนุฑุจู/ุงูุฌููุฒู)", "ุงูุงุฌุชูุงุนูุงุช ูุงูุชุงุฑูุฎ"],
     [{"ุชุฑุจูุฉ ูุฑุขู": 3, "ุชุฑุจูุฉ ุงุณูุงููุฉ": 3}, {"ุชุฑุจูุฉ ุฑูุงุถูุงุช": 3, "ุชุฑุจูุฉ ููุฒูุงุก": 3, "ุชุฑุจูุฉ ููููุงุก": 3, "ุชุฑุจูุฉ ุงุญูุงุก": 3, "ุชุฑุจูุฉ ุนููู": 3}, {"ุชุฑุจูุฉ ุนุฑุจู": 3, "ุชุฑุจูุฉ ุงูุฌููุฒู": 3}, {"ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช": 3}]),
    

    
    ("ูุง ูู ูุฏูู ูู ุงูุชุฏุฑูุณุ",
     ["ุชุนุฒูุฒ ุงูููู ุงูุฏูููุฉ ูุงูุฃุฎูุงููุฉ", "ุชูููุฉ ุงูุชูููุฑ ุงูุนููู ูุงูุฑูุงุถู", "ุชุทููุฑ ููุงุฑุงุช ุงููุบุฉ ูุงูุชูุงุตู", "ููู ุงููุถุงูุง ุงูุงุฌุชูุงุนูุฉ ูุงูุชุงุฑูุฎูุฉ"],
     [{"ุชุฑุจูุฉ ูุฑุขู": 3, "ุชุฑุจูุฉ ุงุณูุงููุฉ": 3}, {"ุชุฑุจูุฉ ุฑูุงุถูุงุช": 3, "ุชุฑุจูุฉ ููุฒูุงุก": 3, "ุชุฑุจูุฉ ููููุงุก": 3, "ุชุฑุจูุฉ ุงุญูุงุก": 3, "ุชุฑุจูุฉ ุนููู": 3}, {"ุชุฑุจูุฉ ุนุฑุจู": 3, "ุชุฑุจูุฉ ุงูุฌููุฒู": 3}, {"ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช": 3}]),
]

# ูุชุบูุฑุงุช ุนุงูููุฉ
message_ids: Dict[int, List[int]] = {}  # ุชุฎุฒูู ูุนุฑูุงุช ุงูุฑุณุงุฆู ููู ูุณุชุฎุฏู
current_question_index: Dict[int, int] = {}  # ูุคุดุฑ ุงูุณุคุงู ุงูุญุงูู ููู ูุณุชุฎุฏู
user_scores: Dict[int, Dict[str, int]] = {}  # ููุงุท ุงููุณุชุฎุฏู ููู ุชุฎุตุต
users: Set[int] = set()  # ูุฌููุนุฉ ูุชุชุจุน ุงููุณุชุฎุฏููู ุงููุฑูุฏูู


def load_data() -> Dict[str, Any]:
    """ุชุญููู ุงูุจูุงูุงุช ูู ููู JSON"""
    try:
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        # ุฅูุดุงุก ุจูุงูุงุช ุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ููู ุงูููู ููุฌูุฏุงู
        default_data = {
            "description": "ูุฑุญุจูุง ุจู ูู ุงุฎุชุจุงุฑ ุชุญุฏูุฏ ุงูุชุฎุตุต! ๐ง\nุงุฎุชุฑ ุฅุฌุงุจุงุชู ุจุงุณุชุฎุฏุงู ุงูุฃุฒุฑุงุฑ ุฃุฏูุงู.\n"
                           "ูุฐุง ุงูุงุฎุชุจุงุฑ ุณูุณุงุนุฏู ุนูู ุงูุชุดุงู ุงูุชุฎุตุต ุงูุฏุฑุงุณู ุงูููุงุณุจ ูุดุฎุตูุชู ูููููู. ๐โจ"
        }
        save_data(default_data)
        return default_data


def save_data(data: Dict[str, Any]) -> None:
    """ุญูุธ ุงูุจูุงูุงุช ุฅูู ููู JSON"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)


# ุฏุงูุฉ ูุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
def update_statistics(stat_type: str, data: Dict[str, Any] = None) -> None:
    """ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุจูุช
    
    ุงูุฃููุงุน ุงููุฏุนููุฉ:
    - new_user: ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
    - complete_quiz: ุงูุชูุงู ุงุฎุชุจุงุฑ
    - abandon_quiz: ุฅูุบุงุก ุงุฎุชุจุงุฑ
    - restart_quiz: ุฅุนุงุฏุฉ ุชุดุบูู ุงุฎุชุจุงุฑ
    - question_answer: ุงูุฅุฌุงุจุฉ ุนูู ุณุคุงู (data: {"question_index": int, "choice": int})
    - major_result: ูุชูุฌุฉ ุงูุชุฎุตุต (data: {"major": str})
    """
    # ุชุญููู ุงูุจูุงูุงุช
    bot_data = load_data()
    current_date = time.strftime("%Y-%m-%d")
    
    # ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณู ุงูุฅุญุตุงุฆูุงุช
    if "statistics" not in bot_data:
        bot_data["statistics"] = {
            "total_users": 0,
            "completed_quizzes": 0,
            "abandoned_quizzes": 0,
            "restart_count": 0,
            "major_results": {},
            "question_stats": {},
            "daily_usage": {},
            "user_data": {}
        }
    
    stats = bot_data["statistics"]
    
    # ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ
    if current_date not in stats["daily_usage"]:
        stats["daily_usage"][current_date] = {
            "new_users": 0,
            "completed_quizzes": 0,
            "abandoned_quizzes": 0,
            "restart_count": 0
        }
    
    # ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุญุณุจ ุงูููุน
    if stat_type == "new_user":
        stats["total_users"] += 1
        stats["daily_usage"][current_date]["new_users"] += 1
    
    elif stat_type == "complete_quiz":
        stats["completed_quizzes"] += 1
        stats["daily_usage"][current_date]["completed_quizzes"] += 1
    
    elif stat_type == "abandon_quiz":
        stats["abandoned_quizzes"] += 1
        stats["daily_usage"][current_date]["abandoned_quizzes"] += 1
    
    elif stat_type == "restart_quiz":
        stats["restart_count"] += 1
        stats["daily_usage"][current_date]["restart_count"] += 1
    
    elif stat_type == "question_answer" and data:
        q_index = str(data.get("question_index", "0"))
        choice = str(data.get("choice", "0"))
        
        # ุชููุฆุฉ ุฅุญุตุงุฆูุงุช ุงูุณุคุงู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if "question_stats" not in stats:
            stats["question_stats"] = {}
            
        if q_index not in stats["question_stats"]:
            stats["question_stats"][q_index] = {}
        
        if choice not in stats["question_stats"][q_index]:
            stats["question_stats"][q_index][choice] = 0
        
        stats["question_stats"][q_index][choice] += 1
    
    elif stat_type == "major_result" and data:
        major = data.get("major", "")
        
        if major:
            if "major_results" not in stats:
                stats["major_results"] = {}
                
            if major not in stats["major_results"]:
                stats["major_results"][major] = 0
            
            stats["major_results"][major] += 1
    
    # ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุฅุฐุง ุชู ุชูููุฑ ูุนุฑู ุงููุณุชุฎุฏู
    if data and "user_id" in data:
        user_id = str(data["user_id"])
        
        if "user_data" not in stats:
            stats["user_data"] = {}
            
        if user_id not in stats["user_data"]:
            stats["user_data"][user_id] = {
                "quiz_count": 0,
                "completed_quizzes": 0,
                "abandoned_quizzes": 0,
                "last_active": current_date,
                "results": []
            }
        
        # ุชุญุฏูุซ ุชุงุฑูุฎ ุงููุดุงุท ุงูุฃุฎูุฑ
        stats["user_data"][user_id]["last_active"] = current_date
        
        # ุชุญุฏูุซ ุนุฏุงุฏ ุงูุงุฎุชุจุงุฑุงุช ุญุณุจ ุงูููุน
        if stat_type == "complete_quiz":
            stats["user_data"][user_id]["completed_quizzes"] += 1
            stats["user_data"][user_id]["quiz_count"] += 1
            
            # ุชุณุฌูู ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ ุฅุฐุง ุชู ุชูููุฑูุง
            if "result" in data:
                stats["user_data"][user_id]["results"].append({
                    "date": current_date,
                    "major": data["result"],
                    "score": data.get("score", 0)
                })
        
        elif stat_type == "abandon_quiz":
            stats["user_data"][user_id]["abandoned_quizzes"] += 1
    
    # ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    save_data(bot_data)

# ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู
bot_data = load_data()


def start(update: Update, context: CallbackContext) -> int:
    """ุจุฏุก ุงููุญุงุฏุซุฉ ูุน ุงููุณุชุฎุฏู"""
    user_id = update.effective_user.id
    
    # ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ุงูุงุณุชุฏุนุงุก ูู message ุฃู callback query
    from_callback = update.callback_query is not None
    
    # ุชุญูู ูุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุฌุฏูุฏูุง
    is_new_user = user_id not in users
    users.add(user_id)  # ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุฅูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู
    
    # ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ
    if is_new_user:
        update_statistics("new_user", {"user_id": user_id})

    # ูุณุญ ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ุฅู ูุฌุฏุช
    if not from_callback:
        # ุฅุฐุง ูุงู ุงูุงุณุชุฏุนุงุก ูู ุฑุณุงูุฉ
        cleaning_msg = update.message.reply_text("โณ ุฌุงุฑู ูุณุญ ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ...")
    else:
        # ุฅุฐุง ูุงู ุงูุงุณุชุฏุนุงุก ูู callback query
        cleaning_msg = context.bot.send_message(chat_id=user_id, text="โณ ุฌุงุฑู ูุณุญ ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ...")

    if user_id in message_ids:
        for msg_id in message_ids[user_id]:
            try:
                context.bot.delete_message(chat_id=user_id, message_id=msg_id)
            except Exception as e:
                logger.error(f"Error deleting message: {e}")
        message_ids[user_id] = []

    time.sleep(1)
    try:
        context.bot.delete_message(chat_id=user_id, message_id=cleaning_msg.message_id)
    except Exception as e:
        logger.error(f"Error deleting cleaning message: {e}")

    # ุฅุนุฏุงุฏ ุจูุงูุงุช ุงููุณุชุฎุฏู
    current_question_index[user_id] = 0
    user_scores[user_id] = {major: 0 for major in majors}
    
    if user_id not in message_ids:
        message_ids[user_id] = []

    # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฑุญูุจ ูุน ุชูุณูู ุฌุฐุงุจ ูุฅุจุฏุงุนู
    welcome_text = "โญโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฎ\n"
    welcome_text += "โ   ๐ *ุฏูููู ูุญู ูุณุชูุจูู ุงูุฃูุงุฏููู*   ๐   โ\n"
    welcome_text += "โฐโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฏ\n\n"
    welcome_text += "โจโจ *ุฃููุงู ุจู ูู ุงุฎุชุจุงุฑ ุชุญุฏูุฏ ุงูุชุฎุตุต ุงูุฌุงูุนู* โจโจ\n\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    welcome_text += f"โ {bot_data['description']} โ\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    welcome_text += "๐ *ุฑุญูุชู ุชุจุฏุฃ ููุง* ๐\n\n"
    
    welcome_text += "๐ *ูุน ูุฐุง ุงูุงุฎุชุจุงุฑ ุณุชุชููู ูู:*\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    welcome_text += "โ โ ุงูุชุดุงู ุงูุชุฎุตุต ุงูููุงุณุจ ูุดุฎุตูุชู โ\n"
    welcome_text += "โ โ ูุนุฑูุฉ ูุฌุงูุงุช ุชููุฒู ุงูุฏุฑุงุณูุฉ     โ\n"
    welcome_text += "โ โ ุงูุงุทูุงุน ุนูู ุณุฌู ุงุฎุชุจุงุฑุงุชู        โ\n"
    welcome_text += "โ โ ููุงุฑูุฉ ูุชุงุฆุฌู ุจูุญุงููุงุช ุณุงุจูุฉ    โ\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    welcome_text += "๐ *ุชุนูููุงุช ุงูุงุฎุชุจุงุฑ:*\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    welcome_text += "โ โข ุณุชุฌูุจ ุนูู 30 ุณุคุงู ูุชููุน         โ\n"
    welcome_text += "โ โข ูู ุฅุฌุงุจุฉ ุชุฑุณู ููุงูุญ ูุณุชูุจูู     โ\n"
    welcome_text += "โ โข ุฃุฌุจ ุจุตุฏู ููุญุตูู ุนูู ุฃุฏู ุงููุชุงุฆุฌ โ\n"
    welcome_text += "โ โข ุณุชุญุตู ุนูู ุชูุตูุงุช ุชูุงุณุจ ุดุฎุตูุชู  โ\n"
    welcome_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    
    # ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจุงูุทุฑููุฉ ุงูููุงุณุจุฉ
    if not from_callback:
        welcome_msg = update.message.reply_text(
            welcome_text,
            parse_mode="Markdown"
        )
    else:
        welcome_msg = context.bot.send_message(
            chat_id=user_id,
            text=welcome_text,
            parse_mode="Markdown"
        )
    message_ids[user_id].append(welcome_msg.message_id)

    # ุณุคุงู ุงููุณุชุฎุฏู ุนู ุฑุบุจุชู ูู ุงูุจุฏุก ุจุชุตููู ุฌุฐุงุจ
    keyboard = [
        [
            InlineKeyboardButton("โ ูุนูุ ุฃูุง ุฌุงูุฒ!", callback_data="yes")
        ],
        [
            InlineKeyboardButton("โน๏ธ ูุดุงูุฏุฉ ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ", callback_data="info")
        ],
        [
            InlineKeyboardButton("โฑ๏ธ ูู ููุช ูุงุญู", callback_data="no")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ุฑุณุงูุฉ ูุญูุฒุฉ ููุจุฏุก ูุน ุชูุณูู ุฌููู
    start_prompt = "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    start_prompt += "โ   ๐ *ุฌุงูุฒ ูุงูุชุดุงู ูุณุชูุจููุ*  ๐   โ\n"
    start_prompt += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    start_prompt += "๐ *ูุฑุญุจุงู ุจู ูู ุฑุญูุฉ ุงูุชุดุงู ุฐุงุชู ุงูุฃูุงุฏูููุฉ!*\n\n"
    start_prompt += "๐ซ ูุฐุง ุงูุงุฎุชุจุงุฑ ุตููู ุฎุตูุตุงู ููุณุงุนุฏุชู ูู ุชุญุฏูุฏ ูุณุงุฑู ุงูุฏุฑุงุณู ุงูุฃูุซู ุงูุฐู ูุชูุงูู ูุน ุดุฎุตูุชู ูููููู ูุงูุชูุงูุงุชู.\n\n"
    start_prompt += "โฑ๏ธ ูุฏุฉ ุงูุงุฎุชุจุงุฑ: 5-10 ุฏูุงุฆู ููุท\n"
    start_prompt += "โจ ุงููุชูุฌุฉ: ุชุญุฏูุฏ ุฃูุถู 3 ุชุฎุตุตุงุช ุชูุงุณุจู\n\n"
    start_prompt += "๐ *ุงุฎุชุฑ ูู ุงูุฎูุงุฑุงุช ุฃุฏูุงู:*"
    
    # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฃููุฏ ุจุงูุทุฑููุฉ ุงูููุงุณุจุฉ
    if not from_callback:
        confirm_msg = update.message.reply_text(
            start_prompt,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
    else:
        confirm_msg = context.bot.send_message(
            chat_id=user_id,
            text=start_prompt,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
    message_ids[user_id].append(confirm_msg.message_id)
    return START_CONFIRMATION


def handle_confirmation(update: Update, context: CallbackContext) -> int:
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู ููุจุฏุก ุฃู ุงูุชุฃุฌูู"""
    query = update.callback_query
    try:
        query.answer()
    except Exception as e:
        logger.warning(f"ูู ูุชููู ูู ุงูุฑุฏ ุนูู ุงุณุชุฏุนุงุก ุงูุฒุฑ: {e}")
        # ูุณุชูุฑ ูู ุชูููุฐ ุงููุธููุฉ ุญุชู ูู ูุดู ุงูุฑุฏ ุนูู ุงูุงุณุชุฏุนุงุก
    
    user_id = query.from_user.id

    if query.data == "yes":
        # ุญุฐู ุฑุณุงูุฉ ุงูุชุฃููุฏ
        try:
            context.bot.delete_message(chat_id=user_id, message_id=query.message.message_id)
        except Exception as e:
            logger.error(f"Error deleting message: {e}")
        
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฏุก ุงูุงุฎุชุจุงุฑ
        start_msg = context.bot.send_message(
            chat_id=user_id,
            text="๐ ุฑุงุฆุน! ููุจุฏุฃ ุงูุงุฎุชุจุงุฑ ุงูุขู. ุงุฎุชุฑ ุฅุฌุงุจุงุชู ุจุงุณุชุฎุฏุงู ุงูุฃุฒุฑุงุฑ ุฃุฏูุงู."
        )
        message_ids[user_id].append(start_msg.message_id)
        return ask_next_question(update, context)
    elif query.data == "info":
        # ุนุฑุถ ูุนูููุงุช ุนู ุงูุงุฎุชุจุงุฑ ูุฅุธูุงุฑ ูู ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ
        return show_all_majors(update, context)
    elif query.data == "back_to_welcome":
        # ุงูุนูุฏุฉ ุฅูู ุฑุณุงูุฉ ุงูุชุฑุญูุจ ุงูุฑุฆูุณูุฉ (ุจุนุฏ ุนุฑุถ ูุงุฆูุฉ ุงูุชุฎุตุตุงุช)
        # ุญุฐู ุงูุฑุณุงูุฉ ุงูุญุงููุฉ
        try:
            context.bot.delete_message(chat_id=user_id, message_id=query.message.message_id)
        except Exception as e:
            logger.error(f"Error deleting message: {e}")
        
        # ุฅุนุงุฏุฉ ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฑุญูุจ ูุน ุฃุฒุฑุงุฑ ุงูุงุฎุชูุงุฑ
        return start(update, context)
    else:
        # ุญุฐู ุฑุณุงูุฉ ุงูุชุฃููุฏ
        try:
            context.bot.delete_message(chat_id=user_id, message_id=query.message.message_id)
        except Exception as e:
            logger.error(f"Error deleting message: {e}")
        
        # ุฅุฑุณุงู ุฑุณุงูุฉ ูุฏุงุน
        goodbye_msg = context.bot.send_message(
            chat_id=user_id,
            text="๐ ูุง ูุดููุฉุ ุฎุฐ ููุชู! ุณุฃููู ููุง ูู ุงูุชุธุงุฑู ููุจุฏุฃ ูุบุงูุฑุฉ ุงูุชุดุงู ุดุบูู ูุชู ูุง ููุช ุฌุงูุฒูุง. ุฅูู ุงูููุงุก! ๐"
        )
        message_ids[user_id].append(goodbye_msg.message_id)
        return ConversationHandler.END


def show_all_majors(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ุฌููุน ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ ูู ุงูุจูุช"""
    chat_id = update.effective_chat.id
    user_id = update.effective_user.id
    
    # ุชูุธูู ุงูุชุฎุตุตุงุช ูู ูุฌููุนุงุช
    major_categories = {
        "๐ป ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ": [],
        "๐ง ุชุฎุตุตุงุช ุงูููุฏุณุฉ": [],
        "๐ฌ ุชุฎุตุตุงุช ุงูุนููู": [],
        "๐ฅ ุชุฎุตุตุงุช ุงูุตุญุฉ": [],
        "๐ ุชุฎุตุตุงุช ุงูุฅูุณุงููุงุช ูุงูุงุฌุชูุงุน": [],
        "๐ผ ุชุฎุตุตุงุช ุงูุฃุนูุงู ูุงููุงููู": [],
        "๐จ ุชุฎุตุตุงุช ุงููููู ูุงูุชุตููู": [],
        "๐ฑ ุชุฎุตุตุงุช ุงูุฒุฑุงุนุฉ ูุงูุจูุฆุฉ": []
    }
    
    # ุชุตููู ุงูุชุฎุตุตุงุช ุญุณุจ ุงูุฃูุณุงู
    for major in majors.keys():
        if major in ["ููุฏุณุฉ ุงูุจุฑูุฌูุงุช", "ุนููู ุงูุญุงุณุจ", "ุงูุฐูุงุก ุงูุงุตุทูุงุนู", "ุชูููุฉ ูุนูููุงุช", "ุฃูู ุณูุจุฑุงูู", "ุชุทููุฑ ุงูุฃูุนุงุจ",
                   "ุนูู ุงูุจูุงูุงุช", "ููุฏุณุฉ ุงูุดุจูุงุช", "ุงูุญูุณุจุฉ ุงูุณุญุงุจูุฉ", "ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ"]:
            major_categories["๐ป ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ"].append(major)
        
        elif major in ["ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ", "ุงูููุฏุณุฉ ุงููููุงููููุฉ", "ุงูููุฏุณุฉ ุงููุฏููุฉ", "ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ", "ูููุงุชุฑูููุณ",
                     "ุงูููุฏุณุฉ ุงูููููุฉ", "ููุฏุณุฉ ุงูุทูุฑุงู", "ููุฏุณุฉ ุงููุถุงุก", "ุงูููุฏุณุฉ ุงูุทุจูุฉ", "ุงูููุฏุณุฉ ุงูููููุงุฆูุฉ"]:
            major_categories["๐ง ุชุฎุตุตุงุช ุงูููุฏุณุฉ"].append(major)
        
        elif major in ["ุงูุฑูุงุถูุงุช", "ุงูููุฒูุงุก", "ุงูุฃุญูุงุก", "ุงูููููุงุก", "ุนูู ุงูุจูุฆุฉ",
                      "ุงูุนููู ุงูุจุญุฑูุฉ", "ุงูุฌููููุฌูุง", "ุงูุฃุฑุตุงุฏ ุงูุฌููุฉ", "ุงูููู", "ุนูู ุงูุฃุนุตุงุจ"]:
            major_categories["๐ฌ ุชุฎุตุตุงุช ุงูุนููู"].append(major)
        
        elif major in ["ุทุจ ุจุดุฑู", "ุทุจ ุฃุณูุงู", "ุตูุฏูุฉ", "ุชูุฑูุถ", "ูุฎุชุจุฑุงุช", "ุทุจ ุจูุทุฑู",
                      "ุงูุทุจ ุงูููุณู", "ุงูุนูุงุฌ ุงูุทุจูุนู", "ุงูุชุบุฐูุฉ", "ุงูุตุญุฉ ุงูุนุงูุฉ", "ุงูุทุจ ุงูุจุฏูู"]:
            major_categories["๐ฅ ุชุฎุตุตุงุช ุงูุตุญุฉ"].append(major)
        
        elif major in ["ุนูู ุงูููุณ", "ุงูููุณูุฉ", "ุงูุชุฑุจูุฉ", "ุนูู ุงูุงุฌุชูุงุน", "ุงูุฃุฏุจ ูุงููููู", "ุงูุชุฑุฌูุฉ",
                      "ุนูู ุงูุฅูุณุงู", "ุนูู ุงูุขุซุงุฑ", "ุงูุงุชุตุงู ุงูุฌูุงููุฑู", "ุงูุนููู ุงูุณูุงุณูุฉ", "ุงูุนูุงูุงุช ุงูุฏูููุฉ"]:
            major_categories["๐ ุชุฎุตุตุงุช ุงูุฅูุณุงููุงุช ูุงูุงุฌุชูุงุน"].append(major)
        
        elif major in ["ุฅุฏุงุฑุฉ ุงูุฃุนูุงู", "ุงูุงูุชุตุงุฏ", "ุงูุชุณููู", "ุญููู", "ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ", "ูุญุงุณุจุฉ",
                      "ุฅุฏุงุฑุฉ ุณูุงุณู ุงูุฅูุฏุงุฏ", "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ", "ุฅุฏุงุฑุฉ ุงูุถูุงูุฉ", "ุฑูุงุฏุฉ ุงูุฃุนูุงู", "ุงูุชูููู ูุงูุจููู"]:
            major_categories["๐ผ ุชุฎุตุตุงุช ุงูุฃุนูุงู ูุงููุงููู"].append(major)
        
        elif major in ["ุงูุฌุฑุงููุณ", "ุงูุชุตููู ุงูุฏุงุฎูู", "ุงููููู ุงูุฌูููุฉ", "ุงูุชุตููู ุงูุตูุงุนู", "ุงูุนูุงุฑุฉ ุงูุฏุงุฎููุฉ",
                      "ุชุตููู ุงูุฃุฒูุงุก", "ุงูุณูููุง ูุงูุฅุฎุฑุงุฌ", "ุงูููุณููู", "ุงููุณุฑุญ", "ุงูุชุตููุฑ ุงูููุชูุบุฑุงูู"]:
            major_categories["๐จ ุชุฎุตุตุงุช ุงููููู ูุงูุชุตููู"].append(major)
        
        elif major in ["ุงูุฒุฑุงุนุฉ", "ุงูุทุจ ุงูุจูุทุฑู", "ุงูุบุงุจุงุช", "ุชูุณูู ุงูุญุฏุงุฆู", "ุนูู ุงูููุงู",
                      "ุงูุงุณุชุฏุงูุฉ ุงูุจูุฆูุฉ", "ููุฏุณุฉ ุงูุจูุฆุฉ"]:
            major_categories["๐ฑ ุชุฎุตุตุงุช ุงูุฒุฑุงุนุฉ ูุงูุจูุฆุฉ"].append(major)
    
    # ุจูุงุก ุฑุณุงูุฉ ูุน ุฌููุน ุงูุชุฎุตุตุงุช
    message_text = "๐ *ูุงุฆูุฉ ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ ูู ุงูุงุฎุชุจุงุฑ* ๐\n\n"
    message_text += "ุงุฎุชุจุงุฑ ุดุงูู ูู 30 ุณุคุงู ููุณุงุนุฏุชู ูู ุงูุชุดุงู ุงูุชุฎุตุต ุงูููุงุณุจ ูู\n"
    message_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุงุณุชุฎุฏุงู ููุณ ุตูุบุฉ ุงูุชุฎุตุตุงุช ุงูููุฌูุฏุฉ ูู ููู bot_data.json
    message_text += "๐ *ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ ูู ุงูุงุฎุชุจุงุฑ:*\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ:*\n"
    message_text += "ุชูููููุฌูุง ูุนูููุงุช - ูุธู ูุนูููุงุช - ุนููู ุงูุญุงุณูุจ - ุฃูู ุณูุจุฑุงูู - ุฌุฑุงููุณ\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ุงูููุฏุณุฉ:*\n"
    message_text += "ููุฏุณุฉ ูุฏููุฉ - ููุฏุณุฉ ููุฑุจุงุฆูุฉ - ููุฏุณุฉ ูููุงููููุฉ - ููุฏุณุฉ ูุนูุงุฑูุฉ - ูููุงุชุฑูููุณ - ููุฏุณุฉ ุทุจูุฉ ูุญูููุฉ\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ุงูุตุญุฉ:*\n"
    message_text += "ุทุจ ูุฌุฑุงุญุฉ - ูุฎุชุจุฑุงุช - ุชูุฑูุถ - ุชุฎุฏูุฑ - ุชุบุฐูุฉ ุนูุงุฌูุฉ - ุงูุงุดุนุฉ - ุนูุงุฌ ุทุจูุนู - ุทุจ ุงุณูุงู - ููู ุงุณูุงู - ุตูุฏูุฉ\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ุงูุฃุนูุงู:*\n"
    message_text += "ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ุงูุฅูุณุงููุงุช:*\n"
    message_text += "ุนูู ุงูููุณ - ุชุฑุฌูุฉ\n\n"
    
    message_text += "โ *ุชุฎุตุตุงุช ูููุฉ ุงูุชุฑุจูุฉ:*\n"
    message_text += "ุชุฑุจูุฉ ูุฑุขู - ุชุฑุจูุฉ ุงุณูุงููุฉ - ุชุฑุจูุฉ ุฑูุงุถูุงุช - ุชุฑุจูุฉ ุนุฑุจู - ุชุฑุจูุฉ ุนููู - ุชุฑุจูุฉ ุงุฌุชูุงุนูุงุช - ุชุฑุจูุฉ ููุฒูุงุก - ุชุฑุจูุฉ ููููุงุก - ุชุฑุจูุฉ ุงุญูุงุก - ุชุฑุจูุฉ ุงูุฌููุฒู\n"
    
    # ุฅุถุงูุฉ ูุนูููุงุช ุนู ููููุฉ ุงูุญุตูู ุนูู ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุชุฎุตุตุงุช
    message_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    message_text += "๐ *ููุญุตูู ุนูู ูุนูููุงุช ุชูุตูููุฉ ุนู ุฃู ุชุฎุตุต*:\n"
    message_text += "ูู ุจุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑ ูุนูุฏ ุธููุฑ ุงููุชุงุฆุฌ ุงุถุบุท ุนูู ุฒุฑ 'ูุนูููุงุช ุฃูุซุฑ ุนู ุงูุชุฎุตุต' ๐\n\n"
    
    # ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุชููู
    keyboard = [
        [
            InlineKeyboardButton("๐ ุจุฏุก ุงูุงุฎุชุจุงุฑ", callback_data="yes"),
            InlineKeyboardButton("๐ ุงูุนูุฏุฉ", callback_data="back_to_welcome")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ุญุฐู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ ุฅู ูุฌุฏุช
    if hasattr(context, 'all_majors_message_id'):
        try:
            context.bot.delete_message(chat_id=chat_id, message_id=context.all_majors_message_id)
        except Exception as e:
            logger.error(f"Error deleting message: {e}")
    
    # ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฌููุน ุงูุชุฎุตุตุงุช
    msg = context.bot.send_message(
        chat_id=chat_id,
        text=message_text,
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )
    
    # ุชุฎุฒูู ูุนุฑู ุงูุฑุณุงูุฉ ููุงุณุชุฎุฏุงู ูุงุญูุงู
    if user_id in message_ids:
        message_ids[user_id].append(msg.message_id)
    else:
        message_ids[user_id] = [msg.message_id]
    context.all_majors_message_id = msg.message_id
    
    return START_CONFIRMATION


def ask_next_question(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ุงูุณุคุงู ุงูุชุงูู ูููุณุชุฎุฏู"""
    user_id = update.effective_chat.id
    index = current_question_index[user_id]

    # ุงูุชุญูู ูู ูุฌูุฏ ุฃุณุฆูุฉ ุฃุฎุฑู
    if index < len(questions):
        question, options, _ = questions[index]
        
        # ุฅูุดุงุก ุฃุฒุฑุงุฑ ุงูุฅุฌุงุจุงุช ูุน ุฑููุฒ ุชุนุจูุฑูุฉ
        keyboard = []
        choice_icons = ["๐ฐ๏ธ", "๐ฑ๏ธ", "ยฉ๏ธ", "๐ฟ๏ธ", "๐น", "๐ธ", "๐บ", "๐ป"]  # ุฑููุฒ ููุฎูุงุฑุงุช
        for i, option in enumerate(options):
            icon = choice_icons[i] if i < len(choice_icons) else "โช"
            keyboard.append([InlineKeyboardButton(f"{icon} {option}", callback_data=f"{index}:{i}")])
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # ุชูุฏู ุงูุงุฎุชุจุงุฑ
        progress = int((index / len(questions)) * 10)
        progress_bar = "๐ฆ" * progress + "โฌ" * (10 - progress)
        
        # ุฅุถุงูุฉ ุฑูู ุงูุณุคุงู ุงูุญุงูู ูุงูุนุฏุฏ ุงูุฅุฌูุงูู ูุน ุชูุณูู ุฌุฐุงุจ
        question_text = f"โ *ุงูุณุคุงู {index + 1} ูู {len(questions)}* โ\n"
        question_text += f"{progress_bar} ({int((index/len(questions))*100)}%)\n\n"
        question_text += f"๐ {question}\n\n"
        question_text += "๐ ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูููุงุณุจุฉ ูู:"
        
        # ุฅุฑุณุงู ุงูุณุคุงู ูุน ุชูุณูู ูุงุฑูุฏุงูู
        question_msg = context.bot.send_message(
            chat_id=user_id, 
            text=question_text,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
        message_ids[user_id].append(question_msg.message_id)
        return ASKING_QUESTIONS
    else:
        # ุงูุชูุช ุงูุฃุณุฆูุฉุ ุงูุงูุชูุงู ุฅูู ุงููุชุงุฆุฌ
        return finish(update, context)


def handle_button(update: Update, context: CallbackContext) -> int:
    """ูุนุงูุฌุฉ ุงูุฅุฌุงุจุฉ ุนูู ุงูุณุคุงู"""
    query = update.callback_query
    try:
        query.answer()
    except Exception as e:
        logger.warning(f"ูู ูุชููู ูู ุงูุฑุฏ ุนูู ุงุณุชุฏุนุงุก ุงูุฒุฑ: {e}")
        # ูุณุชูุฑ ูู ุชูููุฐ ุงููุธููุฉ ุญุชู ูู ูุดู ุงูุฑุฏ ุนูู ุงูุงุณุชุฏุนุงุก
    
    user_id = query.from_user.id
    query_data = query.data
    
    # ุงูุชุญูู ูู ุฃู ูุฐู ุงุณุชุฌุงุจุฉ ูุณุคุงู ูููุณุช ูุฅุฌุฑุงุก ุขุฎุฑ
    if ":" not in query_data:
        # ูุฐู ููุณุช ุงุณุชุฌุงุจุฉ ูุณุคุงูุ ุจู ุฑุจูุง ุฅุฌุฑุงุก ูุซู "restart" ุฃู "my_history" 
        # ูุฌุจ ุฃู ููุนุงูุฌ ุจูุงุณุทุฉ ูุธููุฉ ุฃุฎุฑู
        logger.info(f"ุฒุฑ ุฅุฌุฑุงุก: {query_data}")
        return FINISHED
    
    # ุงูุชุญูู ูู ุตูุบุฉ ุงูุจูุงูุงุช ูุจู ุงููุนุงูุฌุฉ
    try:
        # ุงุณุชุฎุฑุงุฌ ุฑูู ุงูุณุคุงู ูุฑูู ุงูุฅุฌุงุจุฉ
        index, choice = map(int, query_data.split(":"))
        
        if index == current_question_index[user_id]:
            # ุฅุถุงูุฉ ุงูููุงุท ุจูุงุก ุนูู ุงูุฅุฌุงุจุฉ
            scores = questions[index][2][choice]
            for major, points in scores.items():
                user_scores[user_id][major] += points
        
        # ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุฅุฌุงุจุฉ ุงูุณุคุงู
        update_statistics("question_answer", {
            "user_id": user_id,
            "question_index": index,
            "choice": choice
        })
        
        # ุงูุงูุชูุงู ููุณุคุงู ุงูุชุงูู
        current_question_index[user_id] += 1
        
        # ุญุฐู ุฑุณุงูุฉ ุงูุณุคุงู ุงูุญุงูู
        try:
            context.bot.delete_message(chat_id=user_id, message_id=query.message.message_id)
        except Exception as e:
            logger.error(f"Error deleting message: {e}")
        
        # ุนุฑุถ ุงูุณุคุงู ุงูุชุงูู
        return ask_next_question(update, context)
    except ValueError as ve:
        # ุฎุทุฃ ูู ุชูุณูู ุงูุจูุงูุงุช
        logger.error(f"ุฎุทุฃ ูู ุชูุณูู ุจูุงูุงุช ุงูุฒุฑ: {query_data}, ุงูุฎุทุฃ: {ve}")
        return FINISHED
    except Exception as e:
        logger.error(f"ุญุฏุซุช ูุดููุฉ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฅุฌุงุจุฉ: {query_data}, ุงูุฎุทุฃ: {e}")
        return ASKING_QUESTIONS


def finish(update: Update, context: CallbackContext) -> int:
    """ุฅุธูุงุฑ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ"""
    user_id = update.effective_chat.id
    
    # ุงูุญุตูู ุนูู ุฃูุถู 3 ุชุฎุตุตุงุช
    sorted_majors = sorted(user_scores[user_id].items(), key=lambda x: x[1], reverse=True)
    top_three = sorted_majors[:3]
    
    # ุญูุธ ุชุงุฑูุฎ ุงููุชุงุฆุฌ ูุน ุงูููุช
    now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # ุญูุธ ูู ูุชุงุฆุฌ ุงูุชุฎุตุตุงุช ุจุชูุณูู ุฃูุถู
    all_results = {}
    for major, score in sorted_majors:
        all_results[major] = score
    
    # ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุฅููุงู ุงูุงุฎุชุจุงุฑ ูุน ูุชุงุฆุฌ ููุตูุฉ
    update_statistics("complete_quiz", {
        "user_id": user_id,
        "result": top_three[0][0],
        "score": top_three[0][1],
        "date": now,
        "all_results": all_results
    })
    
    # ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ูุชูุฌุฉ ุงูุชุฎุตุต
    update_statistics("major_result", {
        "user_id": user_id,
        "major": top_three[0][0]
    })
    
    # ุฅุถุงูุฉ ุฑููุฒ ูููุฒุฉ ููุชุฎุตุตุงุช (ุชุญุณูู ุชุบุทูุฉ ุฃูุซุฑ ุดูููุงู)
    major_icons = {
        # ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ
        "ููุฏุณุฉ ุงูุจุฑูุฌูุงุช": "๐ป",
        "ุนููู ุงูุญุงุณุจ": "๐ป",
        "ุงูุฐูุงุก ุงูุงุตุทูุงุนู": "๐ค",
        "ุชูููุฉ ูุนูููุงุช": "๐พ",
        "ุฃูู ุณูุจุฑุงูู": "๐",
        "ุชุทููุฑ ุงูุฃูุนุงุจ": "๐ฎ",
        "ุงูุฌุฑุงููุณ": "๐จ",
        "ุนูู ุงูุจูุงูุงุช": "๐",
        "ููุฏุณุฉ ุงูุดุจูุงุช": "๐",
        "ุงูุญูุณุจุฉ ุงูุณุญุงุจูุฉ": "โ๏ธ",
        
        # ุชุฎุตุตุงุช ุงูููุฏุณุฉ
        "ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ": "๐๏ธ",
        "ุงูููุฏุณุฉ ุงููููุงููููุฉ": "โ๏ธ",
        "ุงูููุฏุณุฉ ุงููุฏููุฉ": "๐๏ธ",
        "ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ": "โก",
        "ูููุงุชุฑูููุณ": "๐ค",
        "ุงูููุฏุณุฉ ุงูููููุฉ": "โข๏ธ",
        "ููุฏุณุฉ ุงูุทูุฑุงู": "โ๏ธ",
        "ููุฏุณุฉ ุงููุถุงุก": "๐",
        "ุงูููุฏุณุฉ ุงูุทุจูุฉ": "๐ฉบ",
        "ุงูููุฏุณุฉ ุงูููููุงุฆูุฉ": "โ๏ธ",
        
        # ุชุฎุตุตุงุช ุงูุนููู
        "ุงูุฑูุงุถูุงุช": "๐ข",
        "ุงูููุฒูุงุก": "โ๏ธ",
        "ุงูุฃุญูุงุก": "๐งฌ",
        "ุงูููููุงุก": "๐งช",
        "ุนูู ุงูุจูุฆุฉ": "๐ณ",
        "ุงูุนููู ุงูุจุญุฑูุฉ": "๐",
        "ุงูุฌููููุฌูุง": "๐ชจ",
        "ุงูุฃุฑุตุงุฏ ุงูุฌููุฉ": "๐ค๏ธ",
        "ุงูููู": "๐ญ",
        "ุนูู ุงูุฃุนุตุงุจ": "๐ง",
        
        # ุชุฎุตุตุงุช ุงูุตุญุฉ
        "ุทุจ ุจุดุฑู": "๐จโโ๏ธ",
        "ุทุจ ุฃุณูุงู": "๐ฆท",
        "ุตูุฏูุฉ": "๐",
        "ุชูุฑูุถ": "๐ฉน",
        "ูุฎุชุจุฑุงุช": "๐งช",
        "ุทุจ ุจูุทุฑู": "๐พ",
        "ุงูุทุจ ุงูููุณู": "๐ง",
        "ุงูุนูุงุฌ ุงูุทุจูุนู": "๐คธ",
        "ุงูุชุบุฐูุฉ": "๐ฅ",
        "ุงูุตุญุฉ ุงูุนุงูุฉ": "๐ฅ",
        
        # ุชุฎุตุตุงุช ุงูุฅูุณุงููุงุช ูุงูุงุฌุชูุงุน
        "ุนูู ุงูููุณ": "๐ง",
        "ุงูููุณูุฉ": "๐ญ",
        "ุงูุชุฑุจูุฉ": "๐จโ๐ซ",
        "ุนูู ุงูุงุฌุชูุงุน": "๐ฅ",
        "ุงูุฃุฏุจ ูุงููููู": "๐",
        "ุงูุชุฑุฌูุฉ": "๐",
        "ุนูู ุงูุฅูุณุงู": "๐ง",
        "ุนูู ุงูุขุซุงุฑ": "๐บ",
        "ุงูุงุชุตุงู ุงูุฌูุงููุฑู": "๐ก",
        "ุงูุนููู ุงูุณูุงุณูุฉ": "๐๏ธ",
        "ุงูุนูุงูุงุช ุงูุฏูููุฉ": "๐",
        
        # ุชุฎุตุตุงุช ุงูุฃุนูุงู ูุงููุงููู
        "ุฅุฏุงุฑุฉ ุงูุฃุนูุงู": "๐ผ",
        "ุงูุงูุชุตุงุฏ": "๐",
        "ุงูุชุณููู": "๐ข",
        "ุญููู": "โ๏ธ",
        "ุชุฌุงุฑุฉ ูุงูุชุตุงุฏ": "๐",
        "ูุญุงุณุจุฉ": "๐งฎ",
        "ุฅุฏุงุฑุฉ ุณูุงุณู ุงูุฅูุฏุงุฏ": "๐",
        "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ": "๐ฅ",
        "ุฅุฏุงุฑุฉ ุงูุถูุงูุฉ": "๐จ",
        "ุฑูุงุฏุฉ ุงูุฃุนูุงู": "๐",
        "ุงูุชูููู ูุงูุจููู": "๐ฐ",
        
        # ุชุฎุตุตุงุช ุงููููู ูุงูุชุตููู
        "ุงูุชุตููู ุงูุฏุงุฎูู": "๐",
        "ุงููููู ุงูุฌูููุฉ": "๐ผ๏ธ",
        "ุงูุชุตููู ุงูุตูุงุนู": "๐ญ",
        "ุงูุนูุงุฑุฉ ุงูุฏุงุฎููุฉ": "๐ช",
        "ุชุตููู ุงูุฃุฒูุงุก": "๐",
        "ุงูุณูููุง ูุงูุฅุฎุฑุงุฌ": "๐ฌ",
        "ุงูููุณููู": "๐ต",
        "ุงููุณุฑุญ": "๐ญ",
        "ุงูุชุตููุฑ ุงูููุชูุบุฑุงูู": "๐ท",
        
        # ุชุฎุตุตุงุช ุงูุฒุฑุงุนุฉ ูุงูุจูุฆุฉ
        "ุงูุฒุฑุงุนุฉ": "๐ฑ",
        "ุงูุบุงุจุงุช": "๐ฒ",
        "ุชูุณูู ุงูุญุฏุงุฆู": "๐ท",
        "ุนูู ุงูููุงู": "๐ง",
        "ุงูุงุณุชุฏุงูุฉ ุงูุจูุฆูุฉ": "โป๏ธ",
        "ููุฏุณุฉ ุงูุจูุฆุฉ": "๐"
    }
    
    # ุชุญุฏูุฏ ุงูุฑููุฒ ููู ุชุฎุตุต
    top_icons = []
    for major, _ in top_three:
        # ุงุณุชุฎุฏุงู ุงูุฑูุฒ ุงูููุงุณุจ ุฃู ุฑูุฒ ุงูุชุฑุงุถู
        icon = major_icons.get(major, "๐")
        top_icons.append(icon)
    
    # ุจูุงุก ุฑุณุงูุฉ ุงููุชุงุฆุฌ ุจุดูู ุฌุฐุงุจ
    result_text = "โจ *ุชูุงูููุง!* โจ\n"
    result_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    result_text += "โ   ๐ *ูุชุงุฆุฌ ุงุฎุชุจุงุฑ ุงูุชุฎุตุต ุงูุฏุฑุงุณู* ๐   โ\n"
    result_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุฅุถุงูุฉ ุงูุชุฑุชูุจ ุงูุฃูู ูุน ุชุฃุซูุฑุงุช ุฎุงุตุฉ
    result_text += f"*๐ฅ ุงูุชุฎุตุต ุงูุฃูุณุจ ูู:* {top_icons[0]} *{top_three[0][0]}*\n"
    result_text += f"     โโ ุงูุชูุงูู: {top_three[0][1]} ููุทุฉ โญ\n\n"
    
    # ุฅุถุงูุฉ ุจุงูู ุงูุชุฎุตุตุงุช ุจุชุตููู ุฌุฐุงุจ
    medal_icons = ["๐ฅ", "๐ฅ"]
    result_text += "*โ ุฎูุงุฑุงุช ุฃุฎุฑู ููุงุณุจุฉ ูู:*\n"
    
    for i, ((major, score), icon) in enumerate(zip(top_three[1:], top_icons[1:]), 1):
        medal = medal_icons[i-1] if i <= len(medal_icons) else "๐น"
        result_text += f"{medal} *{major}* {icon}\n"
        result_text += f"     โโ ุงูุชูุงูู: {score} ููุทุฉ\n"
    
    # ุฅุถุงูุฉ ููุงุญุธุงุช ุฎุชุงููุฉ ูุชุดุฌูุน
    result_text += "\nโจ *ููุงุญุธุฉ:* ูุฐู ุงููุชุงุฆุฌ ุชุนุชูุฏ ุนูู ุฅุฌุงุจุงุชู ูู ุงูุงุฎุชุจุงุฑุ ููู ุชูุฏู ุชูุฌูููุง ุนุงููุง ููุท.\n"
    result_text += "\n๐ *ูุชููู ูู ุงูุชูููู ูู ุงุฎุชูุงุฑ ูุณุงุฑู ุงูุฏุฑุงุณู ุงูููุงุณุจ!* ๐"
    
    # ุญูุธ ุงููุชุงุฆุฌ ูู ุชุงุฑูุฎ ุงููุณุชุฎุฏู
    data = load_data()
    stats = data.get("statistics", {})
    user_data = stats.setdefault("user_data", {}).setdefault(str(user_id), {})
    results = user_data.setdefault("results", [])
    
    # ุฅุถุงูุฉ ูุชูุฌุฉ ุฌุฏูุฏุฉ
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    results.append({
        "date": timestamp,
        "top_major": top_three[0][0],
        "score": top_three[0][1],
        "all_results": {major: score for major, score in sorted_majors}
    })
    
    # ุญูุธ ุงูุจูุงูุงุช
    save_data(data)
    
    # ุฅุฑุณุงู ุงููุชุงุฆุฌ ูุน ุชูุณูู ุงููุต
    result_msg = context.bot.send_message(
        chat_id=user_id,
        text=result_text,
        parse_mode="Markdown"
    )
    message_ids[user_id].append(result_msg.message_id)
    
    # ุชุญุณูู ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช ุงูุชุงููุฉ
    keyboard = [
        [InlineKeyboardButton("๐ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ", callback_data="restart")],
        [InlineKeyboardButton("๐ ุนุฑุถ ุงุฎุชุจุงุฑุงุชู ุงูุณุงุจูุฉ", callback_data="my_history")],
        [InlineKeyboardButton("๐ ูุนูููุงุช ุฃูุซุฑ ุนู ุงูุชุฎุตุต", callback_data="more_info")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    restart_msg = context.bot.send_message(
        chat_id=user_id,
        text="*๐ค ูุงุฐุง ุชุฑูุฏ ุฃู ุชูุนู ุงูุขูุ*",
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )
    message_ids[user_id].append(restart_msg.message_id)
    
    return FINISHED


def restart_quiz(update: Update, context: CallbackContext) -> int:
    """ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ"""
    query = update.callback_query
    try:
        query.answer()
    except Exception as e:
        logger.warning(f"ูู ูุชููู ูู ุงูุฑุฏ ุนูู ุงุณุชุฏุนุงุก ุฒุฑ ุฅุนุงุฏุฉ ุงูุชุดุบูู: {e}")
        # ูุณุชูุฑ ูู ุชูููุฐ ุงููุธููุฉ ุญุชู ูู ูุดู ุงูุฑุฏ ุนูู ุงูุงุณุชุฏุนุงุก
    
    # ุชุณุฌูู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูู ุงูุฅุญุตุงุฆูุงุช
    user_id = query.from_user.id
    update_statistics("restart_quiz", {"user_id": user_id})
    
    # ุญุฐู ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ูุจุฏุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ
    chat_id = query.message.chat_id
    context.bot.send_message(
        chat_id=chat_id,
        text="๐ ุฌุงุฑู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ..."
    )
    
    # ุฅุนุงุฏุฉ ุชููุฆุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู
    if user_id in user_scores:
        # ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุท
        user_scores[user_id] = majors.copy()
    if user_id in current_question_index:
        # ุฅุนุงุฏุฉ ุชุนููู ูุคุดุฑ ุงูุณุคุงู
        current_question_index[user_id] = 0
    
    # ุงุณุชุฏุนุงุก ุฏุงูุฉ start ูู ุฎูุงู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
    context.bot.send_message(
        chat_id=chat_id,
        text="๐ฌ ูุฑุญุจุงู ุจู ูุฌุฏุฏุงู ูู ุงุฎุชุจุงุฑ ุงูุชุดุงู ุงูุชุฎุตุต ุงูููุงุณุจ!"
    )
    
    # ุจุฏุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ
    return ask_next_question(update, context)


def cancel(update: Update, context: CallbackContext) -> int:
    """ุฅูุบุงุก ุงูุงุฎุชุจุงุฑ"""
    user_id = update.effective_user.id
    
    # ุชุณุฌูู ุฅูุบุงุก ุงูุงุฎุชุจุงุฑ ูู ุงูุฅุญุตุงุฆูุงุช
    update_statistics("abandon_quiz", {"user_id": user_id})
    
    cancel_msg = update.message.reply_text("โ ุชู ุฅูุบุงุก ุงูุงุฎุชุจุงุฑ. ููููู ุงูุจุฏุก ูู ุฌุฏูุฏ ุจุฅุฑุณุงู /start")
    
    if user_id in message_ids:
        message_ids[user_id].append(cancel_msg.message_id)
    
    return ConversationHandler.END


# ูุธุงุฆู ููุญุฉ ุงูุฅุดุฑุงู ูููุฏูุฑ
def admin_panel(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ููุญุฉ ุชุญูู ุงููุฏูุฑ"""
    user_id = update.effective_user.id
    
    # ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุงููุฏูุฑ
    if user_id != ADMIN_CHAT_ID:
        update.message.reply_text("โ ุนุฐุฑูุงุ ูุฐุง ุงูุฃูุฑ ูุฎุตุต ูููุดุฑู ููุท!")
        return ConversationHandler.END

    # ุนุฑุถ ุฎูุงุฑุงุช ููุญุฉ ุงูุชุญูู
    keyboard = [
        [InlineKeyboardButton("๐ ููุญุฉ ุงูุฅุญุตุงุฆูุงุช", callback_data="user_stats")],
        [InlineKeyboardButton("๐ ุฅุญุตุงุฆูุงุช ุงูุชุฎุตุตุงุช", callback_data="major_stats")],
        [InlineKeyboardButton("๐ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ", callback_data="daily_stats")],
        [InlineKeyboardButton("๐ ุนุฑุถ ุงููุตู ุงูุญุงูู", callback_data="show_desc")],
        [InlineKeyboardButton("โ๏ธ ุชุนุฏูู ูุตู ุงูุชุฑุญูุจ", callback_data="edit_desc")],
        [InlineKeyboardButton("โ ุฎุฑูุฌ", callback_data="exit")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ุชุญููู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    data = load_data()
    stats = data.get("statistics", {})
    
    # ุฅุนุฏุงุฏ ูุต ููุฎุต ููุฅุญุตุงุฆูุงุช
    stats_summary = f"ุฅุฌูุงูู ุงููุณุชุฎุฏููู: {stats.get('total_users', 0)} | "
    stats_summary += f"ุงุฎุชุจุงุฑุงุช ููุชููุฉ: {stats.get('completed_quizzes', 0)}"
    
    update.message.reply_text(
        f"๐จโ๐ผ ูุฑุญุจูุง ุจู ูู ููุญุฉ ุงูุฅุดุฑุงู!\n\n{stats_summary}\n\nุงุฎุชุฑ ุฎูุงุฑูุง ูู ุงููุงุฆูุฉ ุฃุฏูุงู:",
        reply_markup=reply_markup
    )
    
    return ADMIN_PANEL


def handle_admin_choice(update: Update, context: CallbackContext) -> int:
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑุงุช ุงููุฏูุฑ ูู ููุญุฉ ุงูุชุญูู"""
    query = update.callback_query
    query.answer()
    
    # ุชุญููู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    data = load_data()
    stats = data.get("statistics", {})
    
    if query.data == "user_stats":
        # ุชุฌููุฒ ุฃุฒุฑุงุฑ ุงููุนูููุงุช ุงูุฅุถุงููุฉ
        keyboard = [
            [InlineKeyboardButton("๐ ุฅุญุตุงุฆูุงุช ุงูุชุฎุตุตุงุช", callback_data="major_stats")],
            [InlineKeyboardButton("๐ ุฅุญุตุงุฆูุงุช ุงูุฃุณุฆูุฉ", callback_data="question_stats")],
            [InlineKeyboardButton("๐ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ", callback_data="daily_stats")],
            [InlineKeyboardButton("๐ค ุจูุงูุงุช ุงููุณุชุฎุฏููู", callback_data="user_data")],
            [InlineKeyboardButton("๐ ุฑุฌูุน", callback_data="back_to_admin")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู ุงูุฃุณุงุณูุฉ
        stats_text = "๐ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู:\n\n"
        stats_text += f"๐ฅ ุงูุนุฏุฏ ุงูููู ูููุณุชุฎุฏููู: {stats.get('total_users', 0)}\n"
        stats_text += f"โ ุนุฏุฏ ุงูุงุฎุชุจุงุฑุงุช ุงูููุชููุฉ: {stats.get('completed_quizzes', 0)}\n"
        stats_text += f"โ ุนุฏุฏ ุงูุงุฎุชุจุงุฑุงุช ุงูููุบุงุฉ: {stats.get('abandoned_quizzes', 0)}\n"
        stats_text += f"๐ ุนุฏุฏ ูุฑุงุช ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ: {stats.get('restart_count', 0)}\n\n"
        stats_text += "ุงุฎุชุฑ ูู ุงููุงุฆูุฉ ุฃุฏูุงู ูุนุฑุถ ุงููุฒูุฏ ูู ุงูุชูุงุตูู:"
        
        query.edit_message_text(
            text=stats_text,
            reply_markup=reply_markup
        )
        
        return ADMIN_PANEL
        
    elif query.data == "major_stats":
        # ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุชุฎุตุตุงุช
        major_results = stats.get("major_results", {})
        
        if not major_results:
            stats_text = "๐ ูุง ุชูุฌุฏ ุจูุงูุงุช ุนู ูุชุงุฆุฌ ุงูุชุฎุตุตุงุช ุจุนุฏ"
        else:
            # ุชุฑุชูุจ ุงูุชุฎุตุตุงุช ุญุณุจ ุงูุดุนุจูุฉ
            sorted_majors = sorted(major_results.items(), key=lambda x: x[1], reverse=True)
            
            stats_text = "๐ ุฅุญุตุงุฆูุงุช ุงูุชุฎุตุตุงุช:\n\n"
            for major, count in sorted_majors:
                stats_text += f"- {major}: {count} ูุณุชุฎุฏู\n"
        
        query.edit_message_text(
            text=stats_text,
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("๐ ุฑุฌูุน ููุฅุญุตุงุฆูุงุช", callback_data="user_stats")]])
        )
        
        return ADMIN_PANEL
        
    elif query.data == "question_stats":
        # ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุฃุณุฆูุฉ
        question_stats = stats.get("question_stats", {})
        
        if not question_stats:
            stats_text = "โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุนู ุฅุฌุงุจุงุช ุงูุฃุณุฆูุฉ ุจุนุฏ"
        else:
            stats_text = "โ ุฅุญุตุงุฆูุงุช ุงูุฃุณุฆูุฉ:\n\n"
            
            for q_index, choices in sorted(question_stats.items(), key=lambda x: int(x[0])):
                q_index_int = int(q_index)
                if q_index_int < len(questions):
                    question_text = questions[q_index_int][0]
                    stats_text += f"ุงูุณุคุงู {int(q_index) + 1}: {question_text}\n"
                    
                    # ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูููู ููุฐุง ุงูุณุคุงู
                    total_answers = sum(choices.values())
                    
                    # ุนุฑุถ ูู ุฎูุงุฑ ููุณุจุชู
                    for choice_idx, count in sorted(choices.items(), key=lambda x: int(x[0])):
                        choice_idx_int = int(choice_idx)
                        if choice_idx_int < len(questions[q_index_int][1]):
                            choice_text = questions[q_index_int][1][choice_idx_int]
                            percentage = (int(count) / total_answers) * 100 if total_answers > 0 else 0
                            stats_text += f"  - {choice_text}: {count} ({percentage:.1f}%)\n"
                    
                    stats_text += "\n"
        
        query.edit_message_text(
            text=stats_text,
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("๐ ุฑุฌูุน ููุฅุญุตุงุฆูุงุช", callback_data="user_stats")]])
        )
        
        return ADMIN_PANEL
        
    elif query.data == "daily_stats":
        # ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ
        daily_usage = stats.get("daily_usage", {})
        
        if not daily_usage:
            stats_text = "๐ ูุง ุชูุฌุฏ ุจูุงูุงุช ุนู ุงูุงุณุชุฎุฏุงู ุงููููู ุจุนุฏ"
        else:
            # ุชุฑุชูุจ ุงูุฃูุงู ุชูุงุฒูููุง (ุงูุฃุญุฏุซ ุฃููุงู)
            sorted_days = sorted(daily_usage.items(), reverse=True)
            
            stats_text = "๐ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ:\n\n"
            for day, day_stats in sorted_days:
                stats_text += f"๐ {day}:\n"
                stats_text += f"  - ูุณุชุฎุฏููู ุฌุฏุฏ: {day_stats.get('new_users', 0)}\n"
                stats_text += f"  - ุงุฎุชุจุงุฑุงุช ููุชููุฉ: {day_stats.get('completed_quizzes', 0)}\n"
                stats_text += f"  - ุงุฎุชุจุงุฑุงุช ููุบุงุฉ: {day_stats.get('abandoned_quizzes', 0)}\n"
                stats_text += f"  - ุฅุนุงุฏุฉ ุชุดุบูู: {day_stats.get('restart_count', 0)}\n\n"
        
        query.edit_message_text(
            text=stats_text,
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("๐ ุฑุฌูุน ููุฅุญุตุงุฆูุงุช", callback_data="user_stats")]])
        )
        
        return ADMIN_PANEL
        
    elif query.data == "user_data":
        # ุนุฑุถ ุจูุงูุงุช ุงููุณุชุฎุฏููู
        user_data = stats.get("user_data", {})
        
        if not user_data:
            stats_text = "๐ค ูุง ุชูุฌุฏ ุจูุงูุงุช ููุตูุฉ ุนู ุงููุณุชุฎุฏููู ุจุนุฏ"
        else:
            # ุนุฑุถ ููุฎุต ูุจูุงูุงุช ุงููุณุชุฎุฏููู
            stats_text = "๐ค ุจูุงูุงุช ุงููุณุชุฎุฏููู:\n\n"
            stats_text += f"ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุณุฌููู: {len(user_data)}\n\n"
            
            # ุงููุณุชุฎุฏููู ุงูุฃูุซุฑ ูุดุงุทูุง (ุญุณุจ ุนุฏุฏ ุงูุงุฎุชุจุงุฑุงุช ุงูููุชููุฉ)
            active_users = sorted(user_data.items(), key=lambda x: x[1].get('completed_quizzes', 0), reverse=True)[:5]
            
            if active_users:
                stats_text += "ุฃูุซุฑ ุงููุณุชุฎุฏููู ูุดุงุทูุง:\n"
                for user_id, data in active_users:
                    stats_text += f"- ุงููุณุชุฎุฏู {user_id}: {data.get('completed_quizzes', 0)} ุงุฎุชุจุงุฑ ููุชูู\n"
            
            # ุขุฎุฑ ุงููุณุชุฎุฏููู ูุดุงุทูุง
            stats_text += "\nุขุฎุฑ ุงููุณุชุฎุฏููู ูุดุงุทูุง:\n"
            recent_users = sorted(user_data.items(), key=lambda x: x[1].get('last_active', ''), reverse=True)[:5]
            
            for user_id, data in recent_users:
                stats_text += f"- ุงููุณุชุฎุฏู {user_id}: ุขุฎุฑ ูุดุงุท {data.get('last_active', '')}\n"
        
        query.edit_message_text(
            text=stats_text,
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("๐ ุฑุฌูุน ููุฅุญุตุงุฆูุงุช", callback_data="user_stats")]])
        )
        
        return ADMIN_PANEL
    
    elif query.data == "show_desc":
        # ุนุฑุถ ุงููุตู ุงูุญุงูู
        query.edit_message_text(
            text=f"๐ ุงููุตู ุงูุญุงูู:\n\n{bot_data['description']}",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("๐ ุฑุฌูุน", callback_data="back_to_admin")]])
        )
        
        return ADMIN_PANEL
    
    elif query.data == "edit_desc":
        # ุชุนุฏูู ูุตู ุงูุชุฑุญูุจ
        query.edit_message_text("โ๏ธ ุฃุฑุณู ุงููุตู ุงูุฌุฏูุฏ:")
        return EDIT_DESCRIPTION
    
    elif query.data == "back_to_admin":
        # ุงูุนูุฏุฉ ูููุญุฉ ุงูุฅุดุฑุงู
        return admin_panel_callback(update, context)
    
    elif query.data == "exit":
        # ุงูุฎุฑูุฌ ูู ููุญุฉ ุงูุฅุดุฑุงู
        query.edit_message_text("๐ ุชู ุงูุฎุฑูุฌ ูู ููุญุฉ ุงูุฅุดุฑุงู.")
        return ConversationHandler.END
    
    return ADMIN_PANEL


def admin_panel_callback(update: Update, context: CallbackContext) -> int:
    """ุฅุนุงุฏุฉ ุนุฑุถ ููุญุฉ ุชุญูู ุงููุฏูุฑ"""
    query = update.callback_query
    
    # ุนุฑุถ ุฎูุงุฑุงุช ููุญุฉ ุงูุชุญูู
    keyboard = [
        [InlineKeyboardButton("๐ ููุญุฉ ุงูุฅุญุตุงุฆูุงุช", callback_data="user_stats")],
        [InlineKeyboardButton("๐ ุฅุญุตุงุฆูุงุช ุงูุชุฎุตุตุงุช", callback_data="major_stats")],
        [InlineKeyboardButton("๐ ุงูุฅุญุตุงุฆูุงุช ุงูููููุฉ", callback_data="daily_stats")],
        [InlineKeyboardButton("๐ ุนุฑุถ ุงููุตู ุงูุญุงูู", callback_data="show_desc")],
        [InlineKeyboardButton("โ๏ธ ุชุนุฏูู ูุตู ุงูุชุฑุญูุจ", callback_data="edit_desc")],
        [InlineKeyboardButton("โ ุฎุฑูุฌ", callback_data="exit")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ุชุญููู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    data = load_data()
    stats = data.get("statistics", {})
    
    # ุฅุนุฏุงุฏ ูุต ููุฎุต ููุฅุญุตุงุฆูุงุช
    stats_summary = f"ุฅุฌูุงูู ุงููุณุชุฎุฏููู: {stats.get('total_users', 0)} | "
    stats_summary += f"ุงุฎุชุจุงุฑุงุช ููุชููุฉ: {stats.get('completed_quizzes', 0)}"
    
    query.edit_message_text(
        f"๐จโ๐ผ ูุฑุญุจูุง ุจู ูู ููุญุฉ ุงูุฅุดุฑุงู!\n\n{stats_summary}\n\nุงุฎุชุฑ ุฎูุงุฑูุง ูู ุงููุงุฆูุฉ ุฃุฏูุงู:",
        reply_markup=reply_markup
    )
    
    return ADMIN_PANEL


def edit_description(update: Update, context: CallbackContext) -> int:
    """ุชุนุฏูู ูุตู ุงูุชุฑุญูุจ"""
    user_id = update.effective_user.id
    
    # ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุงููุฏูุฑ
    if user_id != ADMIN_CHAT_ID:
        return ConversationHandler.END

    # ุชุญุฏูุซ ุงููุตู
    new_desc = update.message.text
    bot_data["description"] = new_desc
    save_data(bot_data)
    
    # ุฅุฑุณุงู ุชุฃููุฏ ุงูุชุญุฏูุซ
    update.message.reply_text("โ ุชู ุชุญุฏูุซ ูุตู ุงูุชุฑุญูุจ ุจูุฌุงุญ!")
    
    # ุงูุนูุฏุฉ ูููุญุฉ ุงูุฅุดุฑุงู
    return admin_panel(update, context)


def show_history(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ุชุงุฑูุฎ ุงุฎุชุจุงุฑุงุช ุงููุณุชุฎุฏู"""
    query = update.callback_query
    query.answer()
    
    user_id = query.from_user.id
    chat_id = query.message.chat_id
    
    # ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู
    data = load_data()
    stats = data.get("statistics", {})
    user_data = stats.get("user_data", {}).get(str(user_id), {})
    
    # ุงูุญุตูู ุนูู ุชุงุฑูุฎ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช
    results_history = user_data.get("results", [])
    
    if not results_history:
        # ูุง ููุฌุฏ ุชุงุฑูุฎ ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ
        no_history_text = "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
        no_history_text += "โ  ๐ *ุณุฌู ุงูุงุฎุชุจุงุฑุงุช ุงูุณุงุจูุฉ*  ๐  โ\n"
        no_history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
        no_history_text += "โ๏ธ *ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ!* โ๏ธ\n\n"
        no_history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
        no_history_text += "โ ๐ ูุจุฏู ุฃู ูุฐุง ุฃูู ุงุฎุชุจุงุฑ      โ\n"
        no_history_text += "โ    ุชููู ุจูุ ุฃู ุฃูู ูู ุชููู     โ\n"
        no_history_text += "โ    ุฃู ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ.         โ\n"
        no_history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
        no_history_text += "โจ *ูุตูุญุฉ ูููุฏุฉ:* โจ\n"
        no_history_text += "๐ ุนูุฏ ุฅููุงู ุงูุงุฎุชุจุงุฑุงุชุ ุณุชุธูุฑ ูุชุงุฆุฌู \n"
        no_history_text += "   ุงูุณุงุจูุฉ ููุง ูุชุชููู ูู ููุงุฑูุชูุง \n"
        no_history_text += "   ููุชุงุจุนุฉ ุชุทูุฑ ููููู ุงูููููุฉ ูุงูุฏุฑุงุณูุฉ!"
        
        keyboard = [
            [InlineKeyboardButton("๐ ุฅุฌุฑุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ", callback_data="restart")],
            [InlineKeyboardButton("๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ", callback_data="back_to_results")]
        ]
        
        context.bot.send_message(
            chat_id=chat_id,
            text=no_history_text,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return FINISHED
    
    # ุนุฑุถ ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑุงุช
    loading_animation = "โณ *ุฌุงุฑู ุชุญููู ุณุฌู ุงุฎุชุจุงุฑุงุชู* โณ\n"
    loading_animation += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    loading_animation += "โ      ๐ ูุฑุฌู ุงูุงูุชุธุงุฑ...      โ\n"
    loading_animation += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    
    loading_msg = context.bot.send_message(
        chat_id=chat_id,
        text=loading_animation,
        parse_mode="Markdown"
    )
    
    # ุญูุธ ุงููุชุงุฆุฌ ูู ุณูุงู ุงููุญุงุฏุซุฉ ููุงุณุชุฎุฏุงู ูู ุงูุชููู
    context.user_data['results_history'] = results_history
    context.user_data['history_page'] = 0
    
    # ุญูุธ ูุนุฑู ุฑุณุงูุฉ ุงูุชุญููู ููุชู ุชุญุฏูุซูุง ูุงุญูุงู
    context.history_message_id = loading_msg.message_id
    
    # ุนุฑุถ ุตูุญุฉ ุงููุชุงุฆุฌ ุงูุฃููู (ุฃุญุฏุซ 5 ูุชุงุฆุฌ)
    return show_history_page(update, context)


def show_history_page(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ุตูุญุฉ ูู ุชุงุฑูุฎ ุงุฎุชุจุงุฑุงุช ุงููุณุชุฎุฏู"""
    query = update.callback_query
    chat_id = query.message.chat_id
    
    # ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ูู ุณูุงู ุงููุญุงุฏุซุฉ
    results_history = context.user_data.get('results_history', [])
    current_page = context.user_data.get('history_page', 0)
    
    # ุนุฏุฏ ุงููุชุงุฆุฌ ูู ูู ุตูุญุฉ
    items_per_page = 5
    total_pages = (len(results_history) + items_per_page - 1) // items_per_page
    
    # ูุทุงู ุงููุชุงุฆุฌ ุงููุนุฑูุถุฉ
    start_idx = current_page * items_per_page
    end_idx = min(start_idx + items_per_page, len(results_history))
    
    # ุฑููุฒ ูููุฒุฉ ููุชุฎุตุตุงุช
    major_icons = {
        "ุงูููุฏุณุฉ": "๐๏ธ",
        "ุงูุทุจ": "โ๏ธ",
        "ุงูุนููู": "๐ฌ",
        "ุงูุญุงุณุจ ุงูุขูู": "๐ป",
        "ุงูุฃุฏุจ": "๐",
        "ุงููููู": "๐จ",
        "ุงูุชุฌุงุฑุฉ": "๐",
        "ุงููุงููู": "โ๏ธ",
        "ุงูุชุฑุจูุฉ": "๐จโ๐ซ",
        "ุงูุฅุนูุงู": "๐ฑ",
        "ุงูุฑูุงุถุฉ": "๐",
        "ุงูุฒุฑุงุนุฉ": "๐ฑ",
        "ุงูุณูุงุญุฉ": "๐๏ธ",
        "ุงูุนูุงุฑุฉ": "๐๏ธ",
        "ุงูุตูุฏูุฉ": "๐",
        "ุงูุชุตููู": "๐ญ",
        "ุนูู ุงูููุณ": "๐ง"
    }
    
    # ุดุฑูุท ุงูุชูุฏู ููุตูุญุงุช
    page_progress = ""
    for i in range(total_pages):
        if i == current_page:
            page_progress += "๐ต"  # ุงูุตูุญุฉ ุงูุญุงููุฉ
        else:
            page_progress += "โช"  # ุงูุตูุญุงุช ุงูุฃุฎุฑู
    
    # ุนุฑุถ ุนููุงู ููุชุงุฑูุฎ ูุน ุชุตููู ุฌุฐุงุจ
    history_text = "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    history_text += "โ  ๐ *ุณุฌู ุงุฎุชุจุงุฑุงุชู ุงูุณุงุจูุฉ* ๐  โ\n"
    history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุฅุถุงูุฉ ูุนูููุงุช ุงูุตูุญุฉ ุจุฅุทุงุฑ ุฌููู
    history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
    history_text += f"โ ๐ *ุตูุญุฉ {current_page + 1} ูู {total_pages}*  {page_progress} โ\n"
    history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุนุฑุถ ุงููุชุงุฆุฌ ูู ูุฐู ุงูุตูุญุฉ ุจุชูุณูู ููุญุณูู
    current_results = results_history[start_idx:end_idx]
    
    for i, result in enumerate(current_results, start=1):
        # ุชุญุฏูุฏ ุฑูุฒ ุงูุชุฎุตุต
        major = result.get('major', 'ุบูุฑ ูุญุฏุฏ')
        icon = major_icons.get(major, "๐")
        
        # ุฅุถุงูุฉ ุงูุชุงุฑูุฎ ูุงูููุช ุจุชูุณูู ุฃููู
        date_str = result.get('date', 'ุชุงุฑูุฎ ุบูุฑ ูุนุฑูู')
        score = result.get('score', 0)
        
        # ุฅุทุงุฑ ุฌููู ููู ูุชูุฌุฉ
        history_text += f"โโโ *ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ #{i}* โโโ\n"
        history_text += f"โ {icon} *ุงูุชุฎุตุต:* {major}\n"
        history_text += f"โ ๐ *ุงูุชุงุฑูุฎ:* {date_str}\n"
        history_text += f"โ ๐ *ุงููุชูุฌุฉ:* {score} ููุทุฉ\n"
        history_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุฅุถุงูุฉ ุชูููุญุงุช ูููุฏุฉ
    if total_pages > 1:
        history_text += "โจ *ูุตุงุฆุญ ูููุฏุฉ:* โจ\n"
        history_text += "๐ ุงุณุชุฎุฏู ุงูุฃุฒุฑุงุฑ ุฃุฏูุงู ููุชููู ุจูู ุตูุญุงุช ุณุฌู ุงุฎุชุจุงุฑุงุชู\n"
        history_text += "๐ ูุงุฑู ุจูู ูุชุงุฆุฌู ุงูุณุงุจูุฉ ููุชุงุจุนุฉ ุชุทูุฑ ููููู ุงูููููุฉ\n"
        history_text += "๐ ุฌุฑุจ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ ูุฑุฉ ุฃุฎุฑู ููุญุตูู ุนูู ูุชุงุฆุฌ ุฃุฏู"
    
    # ุฅูุดุงุก ุฃุฒุฑุงุฑ ุงูุชููู ูุน ุฑููุฒ ุชุนุจูุฑูุฉ
    nav_buttons = []
    
    # ุฃุฒุฑุงุฑ ุงูุณุงุจู ูุงูุชุงูู
    if total_pages > 1:
        nav_row = []
        if current_page > 0:
            nav_row.append(InlineKeyboardButton("โ๏ธ ุงูุณุงุจู", callback_data="prev_page"))
        
        if current_page < total_pages - 1:
            nav_row.append(InlineKeyboardButton("ุงูุชุงูู โถ๏ธ", callback_data="next_page"))
        
        if nav_row:
            nav_buttons.append(nav_row)
    
    # ุฃุฒุฑุงุฑ ุฅุถุงููุฉ
    nav_buttons.append([
        InlineKeyboardButton("๐ ุฅุฌุฑุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ", callback_data="restart"),
        InlineKeyboardButton("๐ ุงูุนูุฏุฉ ูููุชุงุฆุฌ", callback_data="back_to_results")
    ])
    
    reply_markup = InlineKeyboardMarkup(nav_buttons)
    
    # ุฅุฑุณุงู ุฃู ุชุญุฏูุซ ุงูุฑุณุงูุฉ ูุน ุชูุณูู ูุงุฑูุฏุงูู
    if hasattr(context, 'history_message_id'):
        # ุชุญุฏูุซ ุงูุฑุณุงูุฉ ุงูููุฌูุฏุฉ
        try:
            context.bot.edit_message_text(
                text=history_text,
                chat_id=chat_id,
                message_id=context.history_message_id,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"Error updating history message: {e}")
            # ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซุ ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
            msg = context.bot.send_message(
                chat_id=chat_id,
                text=history_text,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
            context.history_message_id = msg.message_id
    else:
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
        msg = context.bot.send_message(
            chat_id=chat_id,
            text=history_text,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
        context.history_message_id = msg.message_id
    
    return VIEW_HISTORY


def show_major_info(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุชุฎุตุต"""
    query = update.callback_query
    query.answer()
    
    user_id = query.from_user.id
    chat_id = query.message.chat_id
    
    # ุงูุญุตูู ุนูู ุจูุงูุงุช ูุชูุฌุฉ ุงููุณุชุฎุฏู
    data = load_data()
    stats = data.get("statistics", {})
    user_data = stats.get("user_data", {}).get(str(user_id), {})
    results = user_data.get("results", [])
    
    # ุงูุญุตูู ุนูู ุฃุญุฏุซ ูุชูุฌุฉ ูู ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑุงุช
    if results:
        latest_result = results[-1]
        top_major = latest_result.get("top_major", "")
    else:
        # ุฅุฐุง ูู ููู ููุงู ูุชุงุฆุฌุ ุนุฑุถ ูุงุฆูุฉ ุจูู ุงูุชุฎุตุตุงุช
        top_major = list(majors.keys())[0]
    
    # ุญูุธ ุงูุชุฎุตุต ุงูุญุงูู ูู ุณูุงู ุงููุญุงุฏุซุฉ
    context.user_data['current_major'] = top_major
    
    # ูุงุฆูุฉ ุงูุชุฎุตุตุงุช ุงููุชุงุญุฉ ููุงุณุชุนุฑุงุถ
    context.user_data['available_majors'] = list(majors.keys())
    context.user_data['major_index'] = context.user_data['available_majors'].index(top_major)
    
    # ุนุฑุถ ูุนูููุงุช ุงูุชุฎุตุต
    return show_major_details(update, context)

def show_major_details(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุชุฎุตุต ุงููุญุฏุฏ"""
    query = update.callback_query
    chat_id = query.message.chat_id if query else update.effective_chat.id
    
    # ุงูุญุตูู ุนูู ุงูุชุฎุตุต ุงูุญุงูู
    current_major = context.user_data.get('current_major', list(majors.keys())[0])
    
    # ุชุญููู ูุนูููุงุช ุงูุชุฎุตุตุงุช ุงูููุตูุฉ ูู ุงูููู
    bot_data = load_data()
    major_details = bot_data.get("major_details", {})
    
    # ูุนูููุงุช ุงูุชุฎุตุตุงุช (ุงุญุชูุงุทูุฉ ูู ุญุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช ูู ููู ุงูุจูุงูุงุช)
    majors_info = {
        "ููุฏุณุฉ ุงูุจุฑูุฌูุงุช": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุชุทููุฑ ูุชุตููู ุงูุจุฑูุฌูุงุช ุจุดูู ูููุฌู ููููููุ ูุน ุงูุชุฑููุฒ ุนูู ุฌูุฏุฉ ูููุงุกุฉ ุฃูุธูุฉ ุงูุจุฑูุฌูุงุช.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุทููุฑ ุจุฑูุฌูุงุช", "ูููุฏุณ ุจุฑูุฌูุงุช", "ูุญูู ูุธู", "ูุฏูุฑ ูุดุงุฑูุน ุชูููุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุจุฑูุฌุฉ", "ุชุตููู ููุงุนุฏ ุงูุจูุงูุงุช", "ุชุญููู ุงููุธู", "ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุฃุณุงุณูุงุช ุงูุจุฑูุฌุฉ", "ููุฏุณุฉ ุงูุจุฑูุฌูุงุช", "ููุงุนุฏ ุงูุจูุงูุงุช", "ููุงูู ุงูุจูุงูุงุช", "ุฃูู ุงููุนูููุงุช"],
            "ุงูุฑูุฒ": "๐ป"
        },
        "ุนููู ุงูุญุงุณุจ": {
            "ูุตู": "ุฏุฑุงุณุฉ ูุธุฑูุฉ ูุนูููุฉ ููุฎูุงุฑุฒููุงุช ูุงูุจุฑูุฌูุงุช ูุงููุนูููุงุชุ ูุน ุงูุชุฑููุฒ ุนูู ููู ุงูููุงููู ุงูุฃุณุงุณูุฉ ูุนููู ุงูุญุงุณุจ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุนุงูู ุญุงุณูุจ", "ูุญูู ุฎูุงุฑุฒููุงุช", "ุจุงุญุซ", "ูุทูุฑ ุจุฑูุฌูุงุช"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชูููุฑ ุงูููุทูู", "ุงูุฑูุงุถูุงุช", "ุงูุจุฑูุฌุฉ", "ุชุตููู ุงูุฎูุงุฑุฒููุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ูุธุฑูุฉ ุงูุญูุณุจุฉ", "ุชุตููู ุงูุจุฑูุฌูุงุช", "ุงูุฐูุงุก ุงูุงุตุทูุงุนู", "ุงูุฎูุงุฑุฒููุงุช"],
            "ุงูุฑูุฒ": "๐ฅ๏ธ"
        },
        "ุงูุฑูุงุถูุงุช": {
            "ูุตู": "ุฏุฑุงุณุฉ ุงูุจูู ุงููุฌุฑุฏุฉ ูุงูุฃููุงุท ูุงูุนูุงูุงุช ุจูู ุงูุฃุฑูุงู ูุงูุฃุดูุงูุ ูุชุทุจููุงุชูุง ุงููุธุฑูุฉ ูุงูุนูููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุนุงูู ุฑูุงุถูุงุช", "ูุญูู ุฅุญุตุงุฆู", "ุนุงูู ุจูุงูุงุช", "ุจุงุญุซ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชูููุฑ ุงูููุทูู", "ุงูุชุญููู ุงูุฑูุงุถู", "ุญู ุงููุดููุงุช", "ุงูุฏูุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงูุชูุงุถู ูุงูุชูุงูู", "ุงูุฌุจุฑ ุงูุฎุทู", "ูุธุฑูุฉ ุงูุฃุนุฏุงุฏ", "ุงูุฅุญุตุงุก ูุงูุงุญุชูุงูุงุช"],
            "ุงูุฑูุฒ": "๐งฎ"
        },
        "ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ": {
            "ูุตู": "ูู ูุนูู ุชุตููู ุงููุจุงูู ูุงูููุดุขุชุ ูุน ูุฑุงุนุงุฉ ุงูุฌูุงูุจ ุงูุฌูุงููุฉ ูุงููุธูููุฉ ูุงูุจูุฆูุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ูุนูุงุฑู", "ูุตูู ุฏุงุฎูู", "ูุฎุทุท ูุฏู", "ูุตูู ููุงุธุฑ ุทุจูุนูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุตููู", "ุงูุฅุจุฏุงุน", "ุงูุฑุณู ุงูููุฏุณู", "ุงุณุชุฎุฏุงู ุจุฑุงูุฌ ุงูุชุตููู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุชุงุฑูุฎ ุงูุนูุงุฑุฉ", "ุชุตููู ูุนูุงุฑู", "ุงูุฑุณู ุงูููุฏุณู", "ูุธุฑูุงุช ุงูุนูุงุฑุฉ"],
            "ุงูุฑูุฒ": "๐๏ธ"
        },
        "ุงูุฌุฑุงููุณ": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุฅูุดุงุก ูุชุทููุฑ ุงูุชุตุงููู ุงูุจุตุฑูุฉุ ุจูุง ูู ุฐูู ุงูุดุนุงุฑุงุช ูุงูุฅุนูุงูุงุช ูุงููุทุจูุนุงุช.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุตูู ุฌุฑุงููู", "ูุตูู ูุงุฌูุงุช", "ูุตูู ููุจ", "ูุฎุฑุฌ ููู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุฅุจุฏุงุน", "ุงููู ุงูุจุตุฑู", "ุจุฑุงูุฌ ุงูุชุตููู", "ุงูุชูููุฑ ุงูููุฏู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุชุตููู ุฌุฑุงููู", "ุงูุชุงูุจูุบุฑุงูู", "ูุธุฑูุฉ ุงูุฃููุงู", "ุงูุชุณููู ุงูุจุตุฑู"],
            "ุงูุฑูุฒ": "๐จ"
        },
        "ุงูููุฒูุงุก": {
            "ูุตู": "ุฏุฑุงุณุฉ ุงูุทุจูุนุฉ ูุงููุงุฏุฉ ูุงูุทุงูุฉ ูุงููููุ ููุญุงููุฉ ููู ููููุฉ ุนูู ุงูููู ุนูู ุงููุณุชููุงุช ุงูุฃุณุงุณูุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุนุงูู ููุฒูุงุก", "ุจุงุญุซ", "ูููุฏุณ ุจุญุซ ูุชุทููุฑ", "ุนุงูู ููู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุญููู ุงูุฑูุงุถู", "ุงูุชูููุฑ ุงูููุฏู", "ุงูุจุญุซ", "ุญู ุงููุดููุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงููููุงูููุง", "ุงูููุฑููุบูุงุทูุณูุฉ", "ุงูููุฒูุงุก ุงูุญุฏูุซุฉ", "ููุฒูุงุก ุงููู"],
            "ุงูุฑูุฒ": "โ๏ธ"
        },
        "ุนูู ุงูููุณ": {
            "ูุตู": "ุฏุฑุงุณุฉ ุงูุนูู ุงูุจุดุฑู ูุงูุณูููุ ูุน ุงูุชุฑููุฒ ุนูู ููู ุงูุนูููุงุช ุงูุนูููุฉ ูุงูุณููููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุนุงูุฌ ููุณู", "ูุณุชุดุงุฑ", "ุจุงุญุซ", "ุฃุฎุตุงุฆู ุงุฌุชูุงุนู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุนุงุทู", "ุงูุงุณุชูุงุน", "ุงูุชุญููู", "ุงูููุงุฑุงุช ุงูุงุฌุชูุงุนูุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุนูู ุงูููุณ ุงูุฅููููููู", "ุนูู ุงูููุณ ุงูุงุฌุชูุงุนู", "ุนูู ุงูููุณ ุงููุนุฑูู"],
            "ุงูุฑูุฒ": "๐ง"
        }
    }
    
    # ูุนูููุงุช ุนู ุงูุชุฎุตุตุงุช ุงูุฃุฎุฑู ุงููููุฉ ุนุงูููุงู
    # ุชุฎุตุตุงุช ุงูุญุงุณูุจ ูุงูุชูููุฉ
    majors_info.update({
        "ุนูู ุงูุจูุงูุงุช": {
            "ูุตู": "ุชุฎุตุต ูุชุนุฏุฏ ุงูุชุฎุตุตุงุช ูุฌูุน ุจูู ุงูุฅุญุตุงุก ูุนููู ุงูุญุงุณูุจ ูุชุญููู ูููุงุช ูุงุฆูุฉ ูู ุงูุจูุงูุงุช ูุงุณุชุฎุฑุงุฌ ุฑุคู ูููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุญูู ุจูุงูุงุช", "ุนุงูู ุจูุงูุงุช", "ูููุฏุณ ุจูุงูุงุช", "ุฃุฎุตุงุฆู ุงูุชุนูู ุงูุขูู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุฅุญุตุงุก ูุงูุฑูุงุถูุงุช", "ุงูุจุฑูุฌุฉ", "ุงูุชุนูู ุงูุขูู", "ุงูุชูููุฑ ุงูุชุญูููู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุฎูุงุฑุฒููุงุช ุงูุจูุงูุงุช ุงูุถุฎูุฉ", "ุงูุชุนูู ุงูุขูู", "ุงูุฅุญุตุงุก ุงูุชุทุจููู", "ุชุญููู ุงูุจูุงูุงุช"],
            "ุงูุฑูุฒ": "๐"
        },
        "ุฃูู ุณูุจุฑุงูู": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุญูุงูุฉ ุงูุฃูุธูุฉ ูุงูุดุจูุงุช ูุงูุจุฑุงูุฌ ูู ุงููุฌูุงุช ุงูุฑูููุฉ ูุชุทููุฑ ุงุณุชุฑุงุชูุฌูุงุช ุฃูููุฉ ูููุคุณุณุงุช.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุญูู ุฃูู ูุนูููุงุช", "ูุฎุชุจุฑ ุงุฎุชุฑุงู", "ูุฏูุฑ ุฃูู ุณูุจุฑุงูู", "ูุณุชุฌูุจ ููุญูุงุฏุซ ุงูุฃูููุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ูุนุฑูุฉ ุจุงูุดุจูุงุช", "ููู ุงูุซุบุฑุงุช ุงูุฃูููุฉ", "ุงูุจุฑูุฌุฉ", "ุงูุชูููุฑ ุงูุชุญูููู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุฃูู ุงูุดุจูุงุช", "ุงูุชุดููุฑ", "ุงุณุชุฌุงุจุฉ ุงูุญูุงุฏุซ", "ุงููุงููู ุงูุณูุจุฑุงูู", "ุชุญููู ุงูุจุฑูุฌูุงุช ุงูุฎุจูุซุฉ"],
            "ุงูุฑูุฒ": "๐"
        },
        "ุชุทููุฑ ุงูุฃูุนุงุจ": {
            "ูุตู": "ุชุฎุตุต ูุฌูุน ุจูู ุงูุจุฑูุฌุฉ ูุงููู ูุชุตููู ูุชุทููุฑ ุฃูุนุงุจ ุงูููุฏูู ุงูุชูุงุนููุฉ ููุญูุงุณูุจ ูุงูุฃุฌูุฒุฉ ุงููุญูููุฉ ูููุตุงุช ุงูุฃูุนุงุจ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุทูุฑ ุฃูุนุงุจ", "ูุตูู ุฃูุนุงุจ", "ูุจุฑูุฌ ูุญุฑูุงุช ุฃูุนุงุจ", "ููุงู ุฃูุนุงุจ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุจุฑูุฌุฉ", "ุชุตููู ุงูุฌุฑุงูููุณ", "ูุญุฑูุงุช ุงูุฃูุนุงุจ", "ุงูุฐูุงุก ุงูุงุตุทูุงุนู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุจุฑูุฌุฉ ุงูุฃูุนุงุจ", "ุงูุฑุณูููุงุช ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ", "ุชุตููู ุงููุณุชููุงุช", "ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฃูุนุงุจ"],
            "ุงูุฑูุฒ": "๐ฎ"
        },
        "ุงูุญูุณุจุฉ ุงูุณุญุงุจูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุชุตููู ูุจูุงุก ูุฅุฏุงุฑุฉ ุงูุจููุฉ ุงูุชุญุชูุฉ ุงูุณุญุงุจูุฉ ูุงูุฎุฏูุงุช ุงููุณุชุถุงูุฉ ุนุจุฑ ุงูุฅูุชุฑูุช.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ุณุญุงุจุฉ", "ูููุฏุณ DevOps", "ูุทูุฑ ุชุทุจููุงุช ุณุญุงุจูุฉ", "ูุฏูุฑ ุจููุฉ ุชุญุชูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุดุจูุงุช", "ุฃูุธูุฉ ุงูุชุดุบูู", "ุงูุฃูู ุงูุณูุจุฑุงูู", "ุฃุฏูุงุช ุงูุณุญุงุจุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุจููุฉ ุงูุณุญุงุจุฉ", "ุงูุชูุฒูุน ูุงูุชูุงุฒู", "ุฃูู ุงูุณุญุงุจุฉ", "ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช"],
            "ุงูุฑูุฒ": "โ๏ธ"
        },
    })
    
    # ุชุฎุตุตุงุช ุงูููุฏุณุฉ
    majors_info.update({
        "ุงูููุฏุณุฉ ุงููุฏููุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุชุตููู ูุชูููุฐ ุงููุดุงุฑูุน ุงูุฅูุดุงุฆูุฉ ูุซู ุงููุจุงูู ูุงูุฌุณูุฑ ูุงูุทุฑู ูุงูุจููุฉ ุงูุชุญุชูุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ูุฏูู", "ูููุฏุณ ุฅูุดุงุฆู", "ูููุฏุณ ุทุฑู", "ูุดุฑู ูุดุงุฑูุน"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุตููู ุงูููุฏุณู", "ุงูุฑูุงุถูุงุช", "ุชุญููู ุงูููุงูู", "ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงููููุงูููุง ุงูุฅูุดุงุฆูุฉ", "ููุฏุณุฉ ุงูุฒูุงุฒู", "ุชุตููู ุงูุฎุฑุณุงูุฉ", "ููุฏุณุฉ ุงูุฃุณุงุณุงุช"],
            "ุงูุฑูุฒ": "๐๏ธ"
        },
        "ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ุงููุธู ุงูููุฑุจุงุฆูุฉ ูุงูุฅููุชุฑูููุฉ ูุชุทุจููุงุช ุงูุทุงูุฉ ุงูููุฑุจุงุฆูุฉ ูุงูุงุชุตุงูุงุช.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ููุฑุจุงุฆู", "ูููุฏุณ ุงุชุตุงูุงุช", "ูููุฏุณ ุทุงูุฉ", "ูููุฏุณ ุชุญูู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุชุตููู ุงูุฏูุงุฆุฑ", "ุจุฑูุฌุฉ ุงูุฃูุธูุฉ ุงููุฏูุฌุฉ", "ุงูุฑูุงุถูุงุช", "ุญู ุงููุดููุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงูุฏูุงุฆุฑ ุงูููุฑุจุงุฆูุฉ", "ุงููุชุฑูููุงุช ุงูููู", "ูุนุงูุฌุฉ ุงูุฅุดุงุฑุงุช", "ูุธู ุงูุชุญูู"],
            "ุงูุฑูุฒ": "โก"
        },
        "ููุฏุณุฉ ุงูุทูุฑุงู": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุชุตููู ูุชุทููุฑ ูุตูุงูุฉ ุงูุทุงุฆุฑุงุช ูุงููุฑูุจุงุช ุงููุถุงุฆูุฉ ููุญุฑูุงุชูุง.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ุทูุฑุงู", "ูููุฏุณ ูุญุฑูุงุช", "ูููุฏุณ ููุงูู", "ูููุฏุณ ุฃูุธูุฉ ุทูุฑุงู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุฏููุงูููุง ุงูููุงุก", "ุงูููุงุฏ ุงููุชูุฏูุฉ", "ุงูุชุตููู ุจูุณุงุนุฏุฉ ุงูุญุงุณูุจ", "ุชุญููู ุงูุฃูุธูุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุฏููุงูููุง ุงูููุงุก", "ูููุงูููุง ุงูุทูุฑุงู", "ุฏูุน ุงูุทุงุฆุฑุงุช", "ููุงูู ุงูุทุงุฆุฑุงุช"],
            "ุงูุฑูุฒ": "โ๏ธ"
        },
        "ุงูููุฏุณุฉ ุงูุทุจูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฌูุน ุจูู ุงูููุฏุณุฉ ูุงูุทุจ ูุชุทููุฑ ุงูุฃุฌูุฒุฉ ูุงููุนุฏุงุช ูุงูุจุฑูุฌูุงุช ุงูุทุจูุฉ ูุญููู ุงูุฑุนุงูุฉ ุงูุตุญูุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูููุฏุณ ุทุจู", "ูุทูุฑ ุฃุฌูุฒุฉ ุทุจูุฉ", "ูููุฏุณ ุฃุจุญุงุซ ุทุจูุฉ", "ูููุฏุณ ุฌูุฏุฉ ุทุจูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุฅููุชุฑูููุงุช", "ูุนุงูุฌุฉ ุงูุฅุดุงุฑุงุช", "ุนูู ุงูุฃุญูุงุก", "ุชุตููู ุงูุฃุฌูุฒุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงูุฃุฌูุฒุฉ ุงูุทุจูุฉ", "ูุนุงูุฌุฉ ุงูุตูุฑ ุงูุทุจูุฉ", "ุงููุณุชุดุนุฑุงุช ุงูุญูููุฉ", "ุงูุชุดุฑูุญ ูุงููุณููููุฌูุง"],
            "ุงูุฑูุฒ": "๐ฉบ"
        },
    })
    
    # ุชุฎุตุตุงุช ุงูุนููู ูุงูุตุญุฉ
    majors_info.update({
        "ุงูุทุจ ุงูููุณู": {
            "ูุตู": "ุชุฎุตุต ุทุจู ูุฑูุฒ ุนูู ุชุดุฎูุต ูุนูุงุฌ ูููุน ุงูุงุถุทุฑุงุจุงุช ุงูุนูููุฉ ูุงูุนุงุทููุฉ ูุงูุณููููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุทุจูุจ ููุณู", "ูุนุงูุฌ ููุณู", "ุจุงุญุซ ูู ุนููู ุงูุฏูุงุบ", "ุงุณุชุดุงุฑู ุตุญุฉ ููุณูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุดุฎูุต ุงูุณุฑูุฑู", "ุงูุชุนุงุทู", "ุงูุชูููุฑ ุงูุชุญูููู", "ููุงุฑุงุช ุงูุชูุงุตู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุนูู ุงูููุณ ุงูุณุฑูุฑู", "ุนูู ุงูุฃุฏููุฉ ุงูููุณูุฉ", "ุงูุทุจ ุงูููุณู ููุจุงูุบูู", "ุทุจ ููุณ ุงูุฃุทูุงู"],
            "ุงูุฑูุฒ": "๐ง"
        },
        "ุงูุตุญุฉ ุงูุนุงูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุชุนุฏุฏ ุงูุชุฎุตุตุงุช ูุฑูุฒ ุนูู ุญูุงูุฉ ูุชุญุณูู ุตุญุฉ ุงูุณูุงู ูู ุฎูุงู ุงูุชุซููู ุงูุตุญู ูุงูููุงูุฉ ูู ุงูุฃูุฑุงุถ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุณุคูู ุตุญุฉ ุนุงูุฉ", "ูุญูู ุณูุงุณุงุช ุตุญูุฉ", "ุจุงุญุซ ูุจุงุฆูุงุช", "ุฃุฎุตุงุฆู ุชุซููู ุตุญู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุชุญููู ุงูุจูุงูุงุช", "ููุงุฑุงุช ุงูุจุญุซ", "ุงูุชูุงุตู ุงููุนุงู", "ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุนูู ุงูุฃูุจุฆุฉ", "ุงูุณูุงุณุงุช ุงูุตุญูุฉ", "ุงูุฅุญุตุงุก ุงูุญููู", "ุตุญุฉ ุงูุจูุฆุฉ", "ุงูููุงูุฉ ูู ุงูุฃูุฑุงุถ"],
            "ุงูุฑูุฒ": "๐"
        },
        "ุนูู ุงูุฃุนุตุงุจ": {
            "ูุตู": "ุชุฎุตุต ุนููู ูุฏุฑุณ ุงูุฌูุงุฒ ุงูุนุตุจู ูุงูุฏูุงุบ ูููููุฉ ุชุฃุซูุฑููุง ุนูู ุงูุณููู ูุงููุธุงุฆู ุงููุนุฑููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุจุงุญุซ ุฃุนุตุงุจ", "ุนุงูู ุฃุนุตุงุจ ุณุฑูุฑู", "ุฃุฎุตุงุฆู ุชุตููุฑ ุฃุนุตุงุจ", "ุฃุฎุตุงุฆู ุฅุนุงุฏุฉ ุชุฃููู ุนุตุจู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชูููุฑ ุงูุชุญูููู", "ููุงุฑุงุช ุงูุจุญุซ", "ุชูููุงุช ุงููุฎุชุจุฑ", "ุชุญููู ุงูุจูุงูุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุชุดุฑูุญ ุงูุฌูุงุฒ ุงูุนุตุจู", "ูุณููููุฌูุง ุงูุฃุนุตุงุจ", "ุนูู ุงูููุณ ุงูุนุตุจู", "ุนูู ุงูุฃุฏููุฉ ุงูุนุตุจูุฉ"],
            "ุงูุฑูุฒ": "๐ฌ"
        },
        "ุงูููู": {
            "ูุตู": "ุชุฎุตุต ุนููู ูุฏุฑุณ ุงูุฃุฌุฑุงู ุงูุณูุงููุฉ ูุงูุธูุงูุฑ ุงูุชู ุชุญุฏุซ ุฎุงุฑุฌ ุงูุบูุงู ุงูุฌูู ููุฃุฑุถ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุนุงูู ููู", "ุจุงุญุซ ููููุงุช", "ูุญูู ุจูุงูุงุช ููููุฉ", "ูููุฏุณ ุชูุณููุจุงุช"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูููุฒูุงุก", "ุงูุฑูุงุถูุงุช", "ุชุญููู ุงูุจูุงูุงุช", "ุงูุจุฑูุฌุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ููุฒูุงุก ููููุฉ", "ุงูููููุงุช", "ุงูููู ุงูุฑุตุฏู", "ููุฒูุงุก ุงููุถุงุก"],
            "ุงูุฑูุฒ": "๐ญ"
        },
        "ุงูุชุบุฐูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ุงูุนูุงูุฉ ุจูู ุงูุบุฐุงุก ูุงูุตุญุฉ ูุชุฃุซูุฑ ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ ุนูู ูุธุงุฆู ุงูุฌุณู.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุฃุฎุตุงุฆู ุชุบุฐูุฉ", "ูุณุชุดุงุฑ ุบุฐุงุฆู", "ุจุงุญุซ ุชุบุฐูุฉ", "ูุฎุทุท ูุฌุจุงุช ุนูุงุฌูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ูุนุฑูุฉ ุจุงูููููุงุก ุงูุญูููุฉ", "ููุงุฑุงุช ุงูุชูุงุตู", "ุงูุชุญููู ุงูุนููู", "ุชุฎุทูุท ุงููุฌุจุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ููููุงุก ุญูููุฉ ููุชุบุฐูุฉ", "ุนูู ุงูุชุบุฐูุฉ ุงูุจุดุฑูุฉ", "ุงูุชุบุฐูุฉ ุงูุนูุงุฌูุฉ", "ุชุฎุทูุท ูุฌุจุงุช"],
            "ุงูุฑูุฒ": "๐ฅ"
        },
    })
    
    # ุชุฎุตุตุงุช ุงูุนููู ุงูุฅูุณุงููุฉ ูุงูุงุฌุชูุงุนูุฉ
    majors_info.update({
        "ุงูุนููู ุงูุณูุงุณูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ุงููุธุฑูุงุช ูุงูููุงุฑุณุงุช ุงูุณูุงุณูุฉ ูุฃูุธูุฉ ุงูุญูู ูุงูุนูุงูุงุช ุจูู ุงููุคุณุณุงุช ุงูุณูุงุณูุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุญูู ุณูุงุณู", "ูุณุชุดุงุฑ ุณูุงุณุงุช", "ุฏุจูููุงุณู", "ุจุงุญุซ ุณูุงุณู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุญููู ุงูููุฏู", "ุงูุจุญุซ", "ุงููุชุงุจุฉ", "ููู ุงูุฃูุธูุฉ ุงูุณูุงุณูุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงููุธุฑูุงุช ุงูุณูุงุณูุฉ", "ุงูุณูุงุณุฉ ุงูููุงุฑูุฉ", "ุงูุนูุงูุงุช ุงูุฏูููุฉ", "ุงูุณูุงุณุฉ ุงูุนุงูุฉ"],
            "ุงูุฑูุฒ": "๐๏ธ"
        },
        "ุงูุนูุงูุงุช ุงูุฏูููุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ุงูุชูุงุนูุงุช ุจูู ุงูุฏูู ูุงูููุธูุงุช ุงูุฏูููุฉ ูุงูุฌูุงุช ุงููุงุนูุฉ ุบูุฑ ุงูุญููููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุฏุจูููุงุณู", "ูุญูู ุดุคูู ุฏูููุฉ", "ูุณุคูู ููุธูุฉ ุฏูููุฉ", "ูุณุชุดุงุฑ ุณูุงุณู ุฏููู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงููุบุงุช ุงูุฃุฌูุจูุฉ", "ุงูุชูุงูุถ", "ุชุญููู ุงูุณูุงุณุงุช", "ููู ุงูุซูุงูุงุช ุงููุฎุชููุฉ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ูุธุฑูุฉ ุงูุนูุงูุงุช ุงูุฏูููุฉ", "ุงูุงูุชุตุงุฏ ุงูุณูุงุณู ุงูุฏููู", "ุงููุงููู ุงูุฏููู", "ุญู ุงููุฒุงุนุงุช"],
            "ุงูุฑูุฒ": "๐"
        },
        "ุงูุงุชุตุงู ุงูุฌูุงููุฑู": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ููููุฉ ุฎูู ูููู ุงููุนูููุงุช ุฅูู ุฌูุงููุฑ ูุงุณุนุฉ ูู ุฎูุงู ูุณุงุฆู ุงูุฅุนูุงู ุงููุฎุชููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุตุญูู", "ูุฏูุฑ ุนูุงูุงุช ุนุงูุฉ", "ููุชุฌ ุฅุนูุงูู", "ูุฏูุฑ ุงุชุตุงูุงุช"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงููุชุงุจุฉ ูุงูุชุญุฑูุฑ", "ุงูุชูุงุตู ุงููุนุงู", "ุฅูุชุงุฌ ุงููุญุชูู", "ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ูุธุฑูุงุช ุงูุงุชุตุงู", "ุงูุตุญุงูุฉ", "ุงูุฅุนูุงู ุงูุฑููู", "ุงูุนูุงูุงุช ุงูุนุงูุฉ"],
            "ุงูุฑูุฒ": "๐ฑ"
        },
    })
    
    # ุชุฎุตุตุงุช ุงูุฃุนูุงู ูุงููุงููู
    majors_info.update({
        "ุฑูุงุฏุฉ ุงูุฃุนูุงู": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุชุทููุฑ ุงูููุงุฑุงุช ูุงููุนุฑูุฉ ุงููุงุฒูุฉ ูุฅูุดุงุก ูุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ุงูุชุฌุงุฑูุฉ ุงูุฌุฏูุฏุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ุฑุงุฆุฏ ุฃุนูุงู", "ูุณุชุดุงุฑ ุฃุนูุงู ูุงุดุฆุฉ", "ูุทูุฑ ุฃุนูุงู", "ูุฏูุฑ ุญุงุถูุฉ ุฃุนูุงู"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุงุจุชูุงุฑ", "ุงูููุงุฏุฉ", "ุญู ุงููุดููุงุช", "ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ููุงุฐุฌ ุงูุฃุนูุงู", "ุงูุชูููู ุงูุฑูุงุฏู", "ุงูุชุณููู ููุดุฑูุงุช ุงููุงุดุฆุฉ", "ุงูุงุจุชูุงุฑ ูุชุตููู ุงูููุชุฌุงุช"],
            "ุงูุฑูุฒ": "๐"
        },
        "ุงูุชูููู ูุงูุจููู": {
            "ูุตู": "ุชุฎุตุต ูุฏุฑุณ ุฅุฏุงุฑุฉ ุงูุฃููุงู ูุงูุงุณุชุซูุงุฑุงุช ูุงูุฃุณูุงู ุงููุงููุฉ ูุงูุนูููุงุช ุงููุตุฑููุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุญูู ูุงูู", "ูุตุฑูู ุงุณุชุซูุงุฑู", "ูุณุชุดุงุฑ ูุงูู", "ูุฏูุฑ ูุญูุธุฉ ุงุณุชุซูุงุฑูุฉ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชุญููู ุงููุงูู", "ุงูุฑูุงุถูุงุช ูุงูุฅุญุตุงุก", "ููู ุงูุฃุณูุงู", "ุงุชุฎุงุฐ ุงููุฑุงุฑุงุช"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุงูุฃุณูุงู ุงููุงููุฉ", "ุงูุชุญููู ุงููุงูู", "ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ", "ุงูุชูููู ุงูุฏููู"],
            "ุงูุฑูุฒ": "๐น"
        },
        "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ": {
            "ูุตู": "ุชุฎุตุต ูุฑูุฒ ุนูู ุฅุฏุงุฑุฉ ุงูููู ุงูุนุงููุฉ ููููุธูุงุชุ ุจูุง ูู ุฐูู ุงูุชูุธูู ูุงูุชุฏุฑูุจ ูุชุทููุฑ ุงูููุธููู.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุฏูุฑ ููุงุฑุฏ ุจุดุฑูุฉ", "ุฃุฎุตุงุฆู ุชูุธูู", "ูุณุชุดุงุฑ ุชุทููุฑ ูููู", "ูุฏูุฑ ุชุฏุฑูุจ ูุชุทููุฑ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูุชูุงุตู ุงููุนุงู", "ุงูุชูุงูุถ", "ุญู ุงููุฒุงุนุงุช", "ููู ุณููู ุงูููุธููู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ", "ูุงููู ุงูุนูู", "ุงูุชุนููุถุงุช ูุงููุฒุงูุง", "ุชุทููุฑ ูุชุฏุฑูุจ ุงูููุธููู"],
            "ุงูุฑูุฒ": "๐ฅ"
        },
    })
    
    # ุฅุฐุง ูุงู ุงูุชุฎุตุต ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุชู ุนุฑุถ ูุนูููุงุช ุนุงูุฉ
    if current_major not in majors_info:
        majors_info[current_major] = {
            "ูุตู": "ุชุฎุตุต ุฃูุงุฏููู ูุชูุญ ุงููุฑุตุฉ ููุทูุงุจ ูุชุทููุฑ ุงููุนุฑูุฉ ูุงูููุงุฑุงุช ูู ูุฌุงู ูุญุฏุฏ ูู ุงูุฏุฑุงุณุฉ.",
            "ูุฌุงูุงุช ุงูุนูู": ["ูุธุงุฆู ูุชุนููุฉ ุจุงูุชุฎุตุต", "ูุธุงุฆู ุฅุฏุงุฑูุฉ", "ูุธุงุฆู ูู ุงูุจุญุซ"],
            "ุงูููุงุฑุงุช ุงููุทููุจุฉ": ["ุงูููุงุฑุงุช ุงูุชูููุฉ", "ููุงุฑุงุช ุงูุชูุงุตู", "ููุงุฑุงุช ุงูุชูููุฑ ุงูููุฏู"],
            "ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ": ["ููุงุฏ ุชุฎุตุตูุฉ", "ููุงุฏ ุนุงูุฉ", "ููุงุฏ ุงุฎุชูุงุฑูุฉ"],
            "ุงูุฑูุฒ": "๐"
        }
    
    # ูุนูููุงุช ุงูุชุฎุตุต ุงูุญุงูู
    major_data = majors_info[current_major]
    
    # ุจูุงุก ุฑุณุงูุฉ ูุนูููุงุช ุงูุชุฎุตุต
    info_text = f"*{major_data['ุงูุฑูุฒ']} ูุนูููุงุช ุนู ุชุฎุตุต {current_major}*\n"
    info_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
    
    # ุงููุตู
    info_text += "*๐ ุงููุตู:*\n"
    info_text += f"{major_data['ูุตู']}\n\n"
    
    # ูุฌุงูุงุช ุงูุนูู
    info_text += "*๐ผ ูุฌุงูุงุช ุงูุนูู:*\n"
    for field in major_data['ูุฌุงูุงุช ุงูุนูู']:
        info_text += f"โข {field}\n"
    info_text += "\n"
    
    # ุงูููุงุฑุงุช ุงููุทููุจุฉ
    info_text += "*๐ง ุงูููุงุฑุงุช ุงููุทููุจุฉ:*\n"
    for skill in major_data['ุงูููุงุฑุงุช ุงููุทููุจุฉ']:
        info_text += f"โข {skill}\n"
    info_text += "\n"
    
    # ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ
    info_text += "*๐ ุฃูู ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ:*\n"
    for subject in major_data['ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ']:
        info_text += f"โข {subject}\n"
    
    # ุจูุงุก ุฃุฒุฑุงุฑ ุงูุชููู
    keyboard = []
    
    # ุฃุฒุฑุงุฑ ุงูุชููู ุจูู ุงูุชุฎุตุตุงุช
    nav_row = []
    available_majors = context.user_data.get('available_majors', list(majors.keys()))
    current_index = context.user_data.get('major_index', 0)
    
    if current_index > 0:
        nav_row.append(InlineKeyboardButton("โ๏ธ ุงูุณุงุจู", callback_data="prev_major"))
    
    if current_index < len(available_majors) - 1:
        nav_row.append(InlineKeyboardButton("ุงูุชุงูู โถ๏ธ", callback_data="next_major"))
    
    if nav_row:
        keyboard.append(nav_row)
    
    # ุฃุฒุฑุงุฑ ุฅุถุงููุฉ
    keyboard.append([
        InlineKeyboardButton("๐ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ", callback_data="restart"),
        InlineKeyboardButton("๐ ุงูุนูุฏุฉ ูููุชุงุฆุฌ", callback_data="back_to_results")
    ])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ุฅุฑุณุงู ุฃู ุชุญุฏูุซ ุงูุฑุณุงูุฉ
    if hasattr(context, 'major_info_message_id'):
        try:
            context.bot.edit_message_text(
                text=info_text,
                chat_id=chat_id,
                message_id=context.major_info_message_id,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"Error updating major info message: {e}")
            msg = context.bot.send_message(
                chat_id=chat_id,
                text=info_text,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
            context.major_info_message_id = msg.message_id
    else:
        msg = context.bot.send_message(
            chat_id=chat_id,
            text=info_text,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
        context.major_info_message_id = msg.message_id
    
    return VIEW_MAJOR_INFO

def show_detailed_major_info(update: Update, context: CallbackContext) -> int:
    """ุนุฑุถ ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุชุฎุตุต ูู ุจูุงูุงุช ุงูุชุฎุตุตุงุช ุงูููุตูุฉ"""
    query = update.callback_query
    query.answer()
    user_id = query.from_user.id
    chat_id = query.message.chat_id
    
    # ุงูุญุตูู ุนูู ุงูุชุฎุตุตุงุช ูู ุขุฎุฑ ุงุฎุชุจุงุฑ (ุฃูุถู 3 ุชุฎุตุตุงุช)
    data = load_data()
    stats = data.get("statistics", {})
    user_data = stats.get("user_data", {}).get(str(user_id), {})
    results = user_data.get("results", [])
    
    # ุชุฎุฒูู ูุงุฆูุฉ ุงูุชุฎุตุตุงุช ุงูููุงุณุจุฉ ูู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ
    top_majors = []
    
    if results:
        # ุขุฎุฑ ูุชูุฌุฉ ูู ุงูุชุงุฑูุฎ
        last_result = results[-1]
        all_results = last_result.get("all_results", {})
        
        # ุชุฑุชูุจ ุงูุชุฎุตุตุงุช ุญุณุจ ุงูููุงุท ุชูุงุฒููุงู
        sorted_majors = sorted(all_results.items(), key=lambda x: x[1], reverse=True)
        
        # ุฃุฎุฐ ุฃูุถู 3 ุชุฎุตุตุงุช ุนูู ุงูุฃูู
        top_majors = [major for major, _ in sorted_majors[:3]]
        
        # ุฅุฐุง ูุงู ููุงู ุชุฎุตุตุงุช ุฃูุซุฑ ุจููุณ ุงูููุงุทุ ูุถูููุง ุฃูุถุงู
        for major, score in sorted_majors[3:]:
            if score >= sorted_majors[2][1]:
                top_majors.append(major)
            else:
                break
    
    # ุฅุฐุง ูู ูุฌุฏ ุชุฎุตุตุงุชุ ูุณุชุฎุฏู ุงููุงุฆูุฉ ุงูุงูุชุฑุงุถูุฉ
    if not top_majors:
        top_majors = list(majors.keys())
    
    # ุญูุธ ูุงุฆูุฉ ุงูุชุฎุตุตุงุช ูู context
    context.user_data['available_majors'] = top_majors
    
    # ุชุนููู ุงููุคุดุฑ ุฅูู ุงูุชุฎุตุต ุงูุฃูู (ุงูุฃุนูู ููุงุทุงู)
    context.user_data['major_index'] = 0
    current_major = top_majors[0]
    context.user_data['current_major'] = current_major
    
    # ุชุญููู ูุนูููุงุช ุงูุชุฎุตุตุงุช ุงูููุตูุฉ ูู ุงูููู
    bot_data = load_data()
    major_details = bot_data.get("major_details", {})
    
    # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ููุงู ูุนูููุงุช ููุตูุฉ ุนู ุงูุชุฎุตุต
    if current_major in major_details:
        major_data = major_details[current_major]
        
        # ุชุญุถูุฑ ุฑุณุงูุฉ ุฌุฐุงุจุฉ ุจูุนูููุงุช ุงูุชุฎุตุต ูุน ุชุตููู ูุญุณู
        icon = major_data.get("icon", "๐")
        
        # ุนููุงู ุฌุฐุงุจ ูุน ุฅุทุงุฑ ูููุฒ
        info_text = f"โจ {icon} *ุชูุงุตูู ุชุฎุตุต {current_major}* {icon} โจ\n"
        info_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
        info_text += "โ   ๐ *ุฏูููู ุงูุดุงูู ููุชุฎุตุต ุงูุฏุฑุงุณู*   โ\n"
        info_text += "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
        
        # ูุณู ุงููุตู ุจุชูุณูู ุฃูุถู
        info_text += "๐ท *ูุจุฐุฉ ุนู ุงูุชุฎุตุต:*\n"
        info_text += f"โโโโโโโโโโโโโโโโโโโโโโโโโ\n"
        info_text += f"โ {major_data.get('description', 'ุบูุฑ ูุชููุฑ')}\n"
        info_text += f"โโโโโโโโโโโโโโโโโโโโโโโโโ\n\n"
        
        # ูุณู ุงูููุฑุฑุงุช ุงูุฏุฑุงุณูุฉ ูุน ุฑููุฒ ูููุฒุฉ
        info_text += "๐ *ุฃูู ุงูููุฑุฑุงุช ุงูุฏุฑุงุณูุฉ:*\n"
        course_icons = ["๐", "๐", "๐", "๐", "๐", "๐"]
        for i, course in enumerate(major_data.get("courses", ["ุบูุฑ ูุชููุฑ"])):
            icon_index = i % len(course_icons)
            info_text += f"{course_icons[icon_index]} {course}\n"
        info_text += "\n"
        
        # ูุณู ุงูููุงุฑุงุช ุจุชูุณูู ุฌุฐุงุจ
        info_text += "๐ช *ุงูููุงุฑุงุช ุงููุทููุจุฉ ูููุฌุงุญ:*\n"
        skill_icons = ["๐น", "๐ธ", "โญ", "โ", "๐"]
        for i, skill in enumerate(major_data.get("skills", ["ุบูุฑ ูุชููุฑ"])):
            icon_index = i % len(skill_icons)
            info_text += f"{skill_icons[icon_index]} {skill}\n"
        info_text += "\n"
        
        # ูุณู ูุฌุงูุงุช ุงูุนูู ุจุชุตููู ูููุฒ
        info_text += "๐ *ูุฑุต ุงูุนูู ููุฌุงูุงุช ุงูุชูุธูู:*\n"
        for path in major_data.get("career_paths", ["ุบูุฑ ูุชููุฑ"]):
            info_text += f"๐ {path}\n"
        info_text += "\n"
        
        # ุชู ุฅุฒุงูุฉ ูุณู ุงูุฌุงูุนุงุช ุจูุงุกู ุนูู ุทูุจ ุงููุณุชุฎุฏู
        
        # ูุณู ูุนูููุงุช ุฅุถุงููุฉ ุจุฅุทุงุฑ ุฎุงุต
        info_text += "๐ก *ูุนูููุงุช ุฅุถุงููุฉ ูููุฉ:*\n"
        info_text += f"โโโโโโโโโโโโโโโโโโโโโโโ\n"
        info_text += f"โ {major_data.get('info', 'ูุง ุชูุฌุฏ ูุนูููุงุช ุฅุถุงููุฉ ูุชุงุญุฉ.')}\n"
        info_text += f"โโโโโโโโโโโโโโโโโโโโโโโ\n\n"
        
        # ููุงุญุธุฉ ุฎุชุงููุฉ
        info_text += "โจ *ูู ุชุฑูุฏ ูุนูููุงุช ุนู ุชุฎุตุต ุขุฎุฑุ* โจ\n"
        info_text += "๐ *ุงุณุชุฎุฏู ุงูุฃุฒุฑุงุฑ ุฃุฏูุงู ููุชููู* ๐"
        
        # ุฃุฒุฑุงุฑ ุงูุชููู ูุญุณูุฉ
        keyboard = [
            [
                InlineKeyboardButton("โฌ๏ธ ุงูุชุฎุตุต ุงูุณุงุจู", callback_data="prev_major"),
                InlineKeyboardButton("ุงูุชุฎุตุต ุงูุชุงูู โก๏ธ", callback_data="next_major")
            ],
            [InlineKeyboardButton("๐ ุงูุนูุฏุฉ ูููุชุงุฆุฌ", callback_data="back_to_results")],
            [InlineKeyboardButton("๐ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ", callback_data="restart")]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # ุชุญุฏูุซ ุฑุณุงูุฉ ุงููุนูููุงุช
        try:
            query.edit_message_text(
                text=info_text,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"Error updating message: {e}")
            context.bot.send_message(
                chat_id=chat_id,
                text=info_text,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
        
        return VIEW_MAJOR_INFO
    else:
        # ุฅุฐุง ูู ุชุชููุฑ ูุนูููุงุช ููุตูุฉุ ุงุณุชุฎุฏู ุฏุงูุฉ ุนุฑุถ ูุนูููุงุช ุงูุชุฎุตุต ุงูุฃุณุงุณูุฉ
        return show_major_details(update, context)

def handle_major_info_navigation(update: Update, context: CallbackContext) -> int:
    """ูุนุงูุฌุฉ ุงูุชููู ุจูู ูุนูููุงุช ุงูุชุฎุตุตุงุช"""
    query = update.callback_query
    query.answer()
    
    available_majors = context.user_data.get('available_majors', list(majors.keys()))
    current_index = context.user_data.get('major_index', 0)
    
    if query.data == "prev_major":
        # ุงูุงูุชูุงู ููุชุฎุตุต ุงูุณุงุจู
        new_index = max(0, current_index - 1)
        context.user_data['major_index'] = new_index
        context.user_data['current_major'] = available_majors[new_index]
        
        # ุงูุฑุฌูุน ุฅูู ุตูุญุฉ ุงููุนูููุงุช ุงูุชูุตูููุฉ
        # ูุณุชุฎุฏู show_detailed_major_info ุฅุฐุง ูุงู ุงูุชุฎุตุต ูู ูุงุฆูุฉ major_details
        bot_data = load_data()
        major_details = bot_data.get("major_details", {})
        
        if context.user_data['current_major'] in major_details:
            # ุชุบููุฑ ุงูุฑุณุงูุฉ ุงูุญุงููุฉ ุจุฏูุงู ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
            # ูุณุชุฎุฏู show_major_details ุฏุงุฆููุง ูุนุฑุถ ุงูุจูุงูุงุช
            return show_major_details(update, context)
        else:
            return show_major_details(update, context)
    
    elif query.data == "next_major":
        # ุงูุงูุชูุงู ููุชุฎุตุต ุงูุชุงูู
        new_index = min(len(available_majors) - 1, current_index + 1)
        context.user_data['major_index'] = new_index
        context.user_data['current_major'] = available_majors[new_index]
        
        # ุงูุฑุฌูุน ุฅูู ุตูุญุฉ ุงููุนูููุงุช ุงูุชูุตูููุฉ
        # ูุณุชุฎุฏู show_detailed_major_info ุฅุฐุง ูุงู ุงูุชุฎุตุต ูู ูุงุฆูุฉ major_details
        bot_data = load_data()
        major_details = bot_data.get("major_details", {})
        
        if context.user_data['current_major'] in major_details:
            # ุชุบููุฑ ุงูุฑุณุงูุฉ ุงูุญุงููุฉ ุจุฏูุงู ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
            # ูุณุชุฎุฏู show_major_details ุฏุงุฆููุง ูุนุฑุถ ุงูุจูุงูุงุช
            return show_major_details(update, context)
        else:
            return show_major_details(update, context)
    
    elif query.data == "back_to_results":
        # ุงูุนูุฏุฉ ูุดุงุดุฉ ุงููุชุงุฆุฌ ูุฅุนุงุฏุฉ ุนุฑุถูุง
        return finish(update, context)
    
    elif query.data == "restart":
        # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ
        return restart_quiz(update, context)
    
    # ุงูุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฃุฎุฑู
    return VIEW_MAJOR_INFO

def handle_history_navigation(update: Update, context: CallbackContext) -> int:
    """ูุนุงูุฌุฉ ุงูุชููู ูู ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑุงุช"""
    query = update.callback_query
    query.answer()
    
    if query.data == "prev_page":
        # ุงูุงูุชูุงู ููุตูุญุฉ ุงูุณุงุจูุฉ
        context.user_data['history_page'] = max(0, context.user_data.get('history_page', 0) - 1)
        return show_history_page(update, context)
    
    elif query.data == "next_page":
        # ุงูุงูุชูุงู ููุตูุญุฉ ุงูุชุงููุฉ
        results_history = context.user_data.get('results_history', [])
        items_per_page = 5
        total_pages = (len(results_history) + items_per_page - 1) // items_per_page
        
        context.user_data['history_page'] = min(
            total_pages - 1,
            context.user_data.get('history_page', 0) + 1
        )
        return show_history_page(update, context)
    
    elif query.data == "back_to_results":
        # ุงูุนูุฏุฉ ูุดุงุดุฉ ุงููุชุงุฆุฌ ูุฅุนุงุฏุฉ ุนุฑุถูุง
        return finish(update, context)
    
    elif query.data == "restart":
        # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ
        return restart_quiz(update, context)
    
    # ุงูุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฃุฎุฑู
    return VIEW_HISTORY


def error_handler(update, context):
    """ูุนุงูุฌ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูู ุงูุจูุช"""
    try:
        if update.callback_query:
            # ุชุฌุงูู ุงูุฃุฎุทุงุก ุงููุชุนููุฉ ุจุงูุงุณุชุฏุนุงุกุงุช ุงููุฏููุฉ
            if "Query is too old" in str(context.error):
                logger.warning("ุชู ุชุฌุงูู ุงุณุชุฏุนุงุก ูุฏูู")
                return
    except:
        pass
    
    # ุชุณุฌูู ุงูุฎุทุฃ
    logger.error(f"ุฎุทุฃ ุจุณุจุจ ุงูุชุญุฏูุซ {update}: {context.error}")

def main() -> None:
    """ุชุดุบูู ุงูุจูุช"""
    # ุชููุฆุฉ ูุธุงู ุงูุชุณุฌูู
    logger.info("ุจุฏุก ุชุดุบูู ุงูุจูุช...")
    
    # ุนุฏุฏ ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู
    max_retries = 10
    retry_count = 0
    retry_delay = 5  # ุซูุงูู
    
    while retry_count < max_retries:
        try:
            # ุฅูุดุงุก ุงููุญุฏุซ
            updater = Updater(TELEGRAM_BOT_TOKEN, request_kwargs={'read_timeout': 30, 'connect_timeout': 30})
            dispatcher = updater.dispatcher
            
            # ุฅุถุงูุฉ ูุนุงูุฌ ุงูุฃุฎุทุงุก
            dispatcher.add_error_handler(error_handler)
    
            # ุชุนุฑูู ูุญุงุฏุซุฉ ุงููุณุชุฎุฏู ุงูุนุงุฏู
            conv_handler = ConversationHandler(
                entry_points=[CommandHandler('start', start)],
                states={
                    START_CONFIRMATION: [CallbackQueryHandler(handle_confirmation)],
                    ASKING_QUESTIONS: [CallbackQueryHandler(handle_button)],
                    FINISHED: [
                        CallbackQueryHandler(restart_quiz, pattern='^restart$'),
                        CallbackQueryHandler(show_history, pattern='^my_history$'),
                        CallbackQueryHandler(show_detailed_major_info, pattern='^more_info$')
                    ],
                    VIEW_HISTORY: [CallbackQueryHandler(handle_history_navigation)],
                    VIEW_MAJOR_INFO: [CallbackQueryHandler(handle_major_info_navigation)]
                },
                fallbacks=[CommandHandler('cancel', cancel)],
                allow_reentry=True
            )
    
            # ุชุนุฑูู ูุญุงุฏุซุฉ ุงููุฏูุฑ
            admin_handler = ConversationHandler(
                entry_points=[CommandHandler('admin', admin_panel)],
                states={
                    ADMIN_PANEL: [CallbackQueryHandler(handle_admin_choice)],
                    EDIT_DESCRIPTION: [MessageHandler(Filters.text & ~Filters.command, edit_description)]
                },
                fallbacks=[CommandHandler('cancel', cancel)]
            )
    
            # ุฅุถุงูุฉ ุงููุญุงุฏุซุงุช ููุชุทุจูู
            dispatcher.add_handler(conv_handler)
            dispatcher.add_handler(admin_handler)
    
            # ุฅุถุงูุฉ ุฑุณุงูุฉ ุจุฏุก ุชุดุบูู
            logger.info("ุจุฏุก ุงูุงุณุชูุงุน ููุฑุณุงุฆู...")
            
            # ุจุฏุก ุงูุจูุช ุจูุธุงู ุงูุงุณุชุทูุงุน ูุน ุชุฌุงูู ุงูุฑุณุงุฆู ุงููุฏููุฉ
            updater.start_polling(drop_pending_updates=True, timeout=30)
            
            # ุชูููุฐ ุงูุจูุช ุญุชู ุงูุถุบุท ุนูู Ctrl-C ุฃู ุงุณุชูุงู ุฅุดุงุฑุฉ ููุชููู
            updater.idle()
            break  # ุงูุฎุฑูุฌ ูู ุงูุญููุฉ ุฅุฐุง ุชู ุงูุชููู ุจุดูู ุทุจูุนู
            
        except Exception as e:
            logger.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุดุบูู ุงูุจูุช: {e}")
            retry_count += 1
            
            if retry_count < max_retries:
                logger.info(f"ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจุนุฏ {retry_delay} ุซูุงูู... (ุงููุญุงููุฉ {retry_count} ูู {max_retries})")
                time.sleep(retry_delay)
                # ุฒูุงุฏุฉ ููุช ุงูุงูุชุธุงุฑ ุชุฏุฑูุฌูุงู
                retry_delay = min(retry_delay * 2, 60)  # ุฒูุงุฏุฉ ุญุชู ุฏูููุฉ ูุงุญุฏุฉ ูุญุฏ ุฃูุตู
            else:
                logger.error(f"ูุดูุช ุฌููุน ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู. ุชููู ุงูุจูุช ุจุนุฏ {max_retries} ูุญุงููุงุช.")
                raise


if __name__ == '__main__':
    main()
